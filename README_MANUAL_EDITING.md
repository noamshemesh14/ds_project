# ğŸ–±ï¸ Manual Schedule Editing & Group Approval System

## ğŸ“ Overview

This system allows users to:
1. **Drag and drop personal study blocks** to reschedule them instantly
2. **Request changes to group meetings** with a democratic approval process
3. **Approve or reject** group change requests from notifications

---

## ğŸ¯ Features

### 1. Personal Block Editing (Instant)
- **What**: Move your personal study blocks by dragging them
- **How**: Drag a blue block (ğŸ‘¤ Personal) to a new time slot
- **Result**: Block moves immediately, no approval needed
- **Why**: You control your own study time

### 2. Group Meeting Changes (Approval Required)
- **What**: Propose new times for group meetings
- **How**: Drag a purple block (ğŸ‘¥ Group) to a new time slot
- **Result**: Change request created, sent to all members
- **Why**: Group decisions require consensus

### 3. Approval Workflow (Democratic)
- **What**: All group members vote on proposed changes
- **How**: Click âœ… Approve or âŒ Reject in notifications
- **Result**: 
  - **All approve** â†’ Change applied automatically
  - **Any reject** â†’ Request cancelled, original time kept
- **Why**: Fair and transparent group coordination

---

## ğŸ–¼ï¸ Visual Guide

### Personal Block (Blue)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ‘¤ ××‘×•× ×œ××“×¢×™ ×”××—×©×‘        â”‚  â† Drag this
â”‚ ××™×©×™                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â†“ (drag & drop)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [New Time Slot]            â”‚  â† Drop here
â”‚ (available)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â†“
âœ… Moved instantly!
```

### Group Block (Purple)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ‘¥ ××‘× ×™ × ×ª×•× ×™× - ×§×‘×•×¦×”     â”‚  â† Drag this
â”‚ ×§×‘×•×¦×ª×™                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â†“ (drag & drop)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [New Time Slot]            â”‚  â† Drop here
â”‚ (available)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”„ ×‘×§×©×ª ×©×™× ×•×™ ××¤×’×© ×§×‘×•×¦×ª×™               â”‚
â”‚                                         â”‚
â”‚ âš ï¸ ×“×•×¨×© ××™×©×•×¨ ××›×œ ×—×‘×¨×™ ×”×§×‘×•×¦×”          â”‚
â”‚                                         â”‚
â”‚ ×–××Ÿ × ×•×›×—×™: ×¨×‘×™×¢×™ 13:00                  â”‚
â”‚           â†’                              â”‚
â”‚ ×–××Ÿ ××•×¦×¢: ×—××™×©×™ 15:00                   â”‚
â”‚                                         â”‚
â”‚ ×¡×™×‘×ª ×”×©×™× ×•×™: ___________                â”‚
â”‚                                         â”‚
â”‚ [ğŸ“¤ ×©×œ×— ×‘×§×©×”] [×‘×™×˜×•×œ]                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”” Notification Examples

### Change Request Notification
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âš ï¸ ×‘×§×©×ª ×©×™× ×•×™ ××¤×’×©: ××‘× ×™ × ×ª×•× ×™× - ×§×‘×•×¦×”     â”‚
â”‚                                              â”‚
â”‚ ×™×•×¡×™ ×›×”×Ÿ ××‘×§×© ×œ×©× ×•×ª ××¤×’×© ×-×¨×‘×™×¢×™ 13:00      â”‚
â”‚ ×œ-×—××™×©×™ 15:00. × ×“×¨×©×ª ××™×©×•×¨ ××›×œ ×”×—×‘×¨×™×.      â”‚
â”‚                                              â”‚
â”‚ ×œ×¤× ×™ 5 ×“×§×•×ª                                  â”‚
â”‚                                              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚ â”‚  âœ… ××©×¨      â”‚  â”‚  âŒ ×“×—×”      â”‚          â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Approval Notification
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âœ… ×©×™× ×•×™ ××¤×’×© ××•×©×¨: ××‘× ×™ × ×ª×•× ×™× - ×§×‘×•×¦×”      â”‚
â”‚                                              â”‚
â”‚ ×›×œ ×—×‘×¨×™ ×”×§×‘×•×¦×” ××™×©×¨×• ××ª ×”×©×™× ×•×™.             â”‚
â”‚ ×”××¤×’×© ×¢×•×“×›×Ÿ ×œ×—××™×©×™ 15:00.                   â”‚
â”‚                                              â”‚
â”‚ ×œ×¤× ×™ ×“×§×”                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Rejection Notification
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âŒ ×©×™× ×•×™ ××¤×’×© × ×“×—×”: ××‘× ×™ × ×ª×•× ×™× - ×§×‘×•×¦×”      â”‚
â”‚                                              â”‚
â”‚ ×©×¨×” ×œ×•×™ ×“×—×” ××ª ×”×‘×§×©×” ×œ×©× ×•×ª ××ª ××•×¢×“ ×”××¤×’×©.   â”‚
â”‚ ×”×–××Ÿ ×”××§×•×¨×™ × ×©××¨: ×¨×‘×™×¢×™ 13:00              â”‚
â”‚                                              â”‚
â”‚ ×œ×¤× ×™ 2 ×“×§×•×ª                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ® Step-by-Step Usage

### Scenario A: Moving Personal Study Time

**Goal**: You want to move "××‘×•× ×œ××“×¢×™ ×”××—×©×‘" from Sunday 09:00 to Monday 14:00

1. Go to `http://localhost:8000/schedule`
2. Find the blue block "ğŸ‘¤ ××‘×•× ×œ××“×¢×™ ×”××—×©×‘" on Sunday at 09:00
3. Click and hold on the block
4. Drag it to Monday 14:00 slot
5. Release the mouse button
6. See alert: "âœ… ×”×‘×œ×•×§ ×”×•×¢×‘×¨ ×‘×”×¦×œ×—×”!"
7. Schedule updates immediately
8. âœ… Done! Your study time is moved.

### Scenario B: Proposing Group Meeting Change

**Goal**: Change "××‘× ×™ × ×ª×•× ×™× - ×§×‘×•×¦×”" from Wednesday 13:00 to Thursday 15:00

1. Go to `http://localhost:8000/schedule`
2. Find the purple block "ğŸ‘¥ ××‘× ×™ × ×ª×•× ×™× - ×§×‘×•×¦×”" on Wednesday at 13:00
3. Click and hold on the block
4. Drag it to Thursday 15:00 slot
5. Release the mouse button
6. Modal opens: "ğŸ”„ ×‘×§×©×ª ×©×™× ×•×™ ××¤×’×© ×§×‘×•×¦×ª×™"
7. See warning: "âš ï¸ ×“×•×¨×© ××™×©×•×¨ ××›×œ ×—×‘×¨×™ ×”×§×‘×•×¦×”"
8. (Optional) Enter reason: "×™×© ×œ×™ ××‘×—×Ÿ ×‘×™×•× ×¨×‘×™×¢×™"
9. Click "ğŸ“¤ ×©×œ×— ×‘×§×©×”"
10. See alert: "âœ… ×‘×§×©×ª ×”×©×™× ×•×™ × ×©×œ×—×”! ×××ª×™× ×™× ×œ××™×©×•×¨ ×-3 ×—×‘×¨×™ ×§×‘×•×¦×”."
11. âœ… Request sent! Wait for approvals.

### Scenario C: Approving/Rejecting as Group Member

**Context**: You receive notification that someone wants to change the meeting time

**Option 1: Approve**
1. Click notifications bell (ğŸ””)
2. See notification: "âš ï¸ ×‘×§×©×ª ×©×™× ×•×™ ××¤×’×©: ××‘× ×™ × ×ª×•× ×™× - ×§×‘×•×¦×”"
3. Read details: "×™×•×¡×™ ×›×”×Ÿ ××‘×§×© ×œ×©× ×•×ª ××¤×’×© ×-×¨×‘×™×¢×™ 13:00 ×œ-×—××™×©×™ 15:00"
4. Click "âœ… ××©×¨"
5. See alert: "Your approval recorded. Waiting for other members."
6. Wait for others to vote

**If you're the last to approve:**
- See alert: "All members approved! Change has been applied."
- Schedule updates automatically
- Everyone receives "âœ… ×©×™× ×•×™ ××¤×’×© ××•×©×¨" notification

**Option 2: Reject**
1. Click notifications bell (ğŸ””)
2. See notification: "âš ï¸ ×‘×§×©×ª ×©×™× ×•×™ ××¤×’×©: ××‘× ×™ × ×ª×•× ×™× - ×§×‘×•×¦×”"
3. Read details: "×™×•×¡×™ ×›×”×Ÿ ××‘×§×© ×œ×©× ×•×ª ××¤×’×©..."
4. Click "âŒ ×“×—×”"
5. Confirm: "×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×“×—×•×ª ××ª ×”×‘×§×©×”?"
6. Click OK
7. See alert: "Change request rejected."
8. Everyone receives "âŒ ×©×™× ×•×™ ××¤×’×© × ×“×—×”" notification
9. Original time preserved

---

## ğŸ”’ Rules & Constraints

### What CAN Be Moved:
- âœ… Personal study blocks (blue, ğŸ‘¤)
- âœ… Group meeting blocks (purple, ğŸ‘¥) - with approval

### What CANNOT Be Moved:
- âŒ Hard constraint blocks (orange)
- âŒ Blocks that are currently being moved
- âŒ Past time slots (can't change history)

### Validation Checks:
- âœ… New slot must be available (not already occupied)
- âœ… New time must respect hard constraints
- âœ… Group changes require unanimous approval
- âœ… Cannot move to same location (no-op)

### Approval Requirements:
- **Personal blocks**: No approval needed (instant)
- **Group blocks**: Requires 100% approval from ALL active members
- **One rejection**: Entire request cancelled
- **Timeout**: Requests expire after 48 hours (auto-reject)

---

## ğŸ¨ UI Indicators

### Drag States
| State | Visual | Description |
|-------|--------|-------------|
| **Idle** | Normal block | Block is ready to drag |
| **Hovering** | `cursor: grab` | Mouse over draggable block |
| **Dragging** | `opacity: 0.5`, `cursor: grabbing` | Block being dragged |
| **Drop Zone** | Blue dashed border, light blue background | Valid drop target |
| **Dropped** | `opacity: 1`, schedule updates | Block placed in new location |

### Block Types
| Type | Color | Icon | Draggable? | Approval? |
|------|-------|------|------------|-----------|
| **Personal** | Blue | ğŸ‘¤ | âœ… Yes | âŒ No |
| **Group** | Purple | ğŸ‘¥ | âœ… Yes | âœ… Yes |
| **Constraint** | Orange | ğŸš« | âŒ No | N/A |

### Notification Types
| Type | Icon | Action Required? |
|------|------|------------------|
| **Change Request** | âš ï¸ | âœ… Yes (Approve/Reject) |
| **Approved** | âœ… | âŒ No (Info only) |
| **Rejected** | âŒ | âŒ No (Info only) |
| **Weekly Schedule** | ğŸ“… | âŒ No (Info only) |

---

## ğŸ§ª Testing Guide

### Test 1: Personal Block Drag & Drop
```bash
# Setup
1. Go to /schedule
2. Ensure you have at least one blue block (personal study)

# Test
3. Hover over blue block â†’ cursor should be "grab"
4. Click and drag â†’ opacity should be 50%
5. Hover over empty slot â†’ blue dashed border appears
6. Drop â†’ alert "×”×‘×œ×•×§ ×”×•×¢×‘×¨ ×‘×”×¦×œ×—×”!"
7. Schedule refreshes â†’ block is in new location

# Success Criteria
âœ… Block moves smoothly
âœ… Visual feedback is clear
âœ… Schedule updates immediately
âœ… Backend logs: "User {id} moved personal block {block_id}"
```

### Test 2: Group Meeting Change Request
```bash
# Setup
1. Go to /schedule
2. Ensure you have at least one purple block (group meeting)
3. You should be in a group with at least 2 members

# Test
4. Drag purple block to new time
5. Drop â†’ modal opens with warning
6. Enter reason: "Testing the system"
7. Click "×©×œ×— ×‘×§×©×”"
8. Check notifications for all group members

# Success Criteria
âœ… Modal opens with correct info
âœ… Request is created in database
âœ… All members receive notification
âœ… Backend logs: "Created group change request {request_id}"
```

### Test 3: Approval Workflow
```bash
# Setup (requires 2+ users in same group)
User A: Create change request (from Test 2)

# Test as User B
1. Log in as different user (group member)
2. Click notifications bell
3. See notification with Approve/Reject buttons
4. Click "××©×¨"
5. Check database: approval recorded

# Test as User C (last member)
6. Log in as third user (if applicable)
7. Click "××©×¨"
8. Check: All users' schedules should update automatically
9. Check: All members receive "××•×©×¨" notification

# Success Criteria
âœ… Each approval is recorded
âœ… Status updates after each vote
âœ… Final approval triggers schedule update
âœ… All members notified
```

### Test 4: Rejection Workflow
```bash
# Setup
User A: Create change request

# Test as User B
1. Log in as different user
2. Click notifications bell
3. Click "×“×—×”"
4. Confirm rejection
5. Check: Request status = "rejected"
6. Check: All members receive "× ×“×—×”" notification
7. Check: Original time preserved

# Success Criteria
âœ… Single rejection cancels request
âœ… Status immediately becomes "rejected"
âœ… All members notified
âœ… Schedule unchanged
```

---

## ğŸ“Š Database Tables

### `group_meeting_change_requests`
```sql
id                     UUID PRIMARY KEY
group_id               UUID (FK â†’ study_groups)
week_start             DATE
original_day_of_week   INTEGER (0-6)
original_start_time    TIME
proposed_day_of_week   INTEGER (0-6)
proposed_start_time    TIME
requested_by           UUID (FK â†’ auth.users)
reason                 TEXT
status                 VARCHAR(20) -- 'pending', 'approved', 'rejected'
created_at             TIMESTAMP
resolved_at            TIMESTAMP
```

### `group_change_approvals`
```sql
id            UUID PRIMARY KEY
request_id    UUID (FK â†’ group_meeting_change_requests)
user_id       UUID (FK â†’ auth.users)
approved      BOOLEAN (true/false)
created_at    TIMESTAMP
responded_at  TIMESTAMP
```

---

## ğŸ”§ API Endpoints

### Move Schedule Block
```http
POST /api/schedule/block/move
Authorization: Bearer {token}
Content-Type: application/json

{
  "block_id": "uuid",
  "new_day_of_week": 1,
  "new_start_time": "14:00"
}

Response 200:
{
  "message": "Block moved successfully",
  "block": { ...updated block... }
}

Response 400 (if group block):
{
  "error": "group_block",
  "message": "Group blocks require approval..."
}
```

### Create Change Request
```http
POST /api/schedule/group-change-request/create
Authorization: Bearer {token}
Content-Type: application/json

{
  "group_id": "uuid",
  "week_start": "2026-02-08",
  "original_day_of_week": 2,
  "original_start_time": "13:00",
  "proposed_day_of_week": 3,
  "proposed_start_time": "15:00",
  "reason": "×™×© ×œ×™ ××‘×—×Ÿ"
}

Response 200:
{
  "message": "Change request created...",
  "request": { ...request object... },
  "members_to_approve": 3
}
```

### Approve Request
```http
POST /api/schedule/group-change-request/{request_id}/approve
Authorization: Bearer {token}

Response 200 (waiting):
{
  "message": "Your approval recorded. Waiting for others.",
  "status": "pending",
  "approved_count": 2,
  "total_members": 4
}

Response 200 (all approved):
{
  "message": "All members approved! Change has been applied.",
  "status": "approved"
}
```

### Reject Request
```http
POST /api/schedule/group-change-request/{request_id}/reject
Authorization: Bearer {token}

Response 200:
{
  "message": "Change request rejected.",
  "status": "rejected"
}
```

---

## ğŸ› Troubleshooting

### Issue: Drag doesn't start
**Symptoms**: Click and drag, nothing happens
**Cause**: Block might not be start of multi-hour block
**Solution**: Only the first cell of a multi-hour block is draggable

### Issue: Drop doesn't work
**Symptoms**: Drop on cell, nothing happens
**Cause**: Cell might already be occupied or constrained
**Solution**: Drop on an available (white/light) cell

### Issue: Group modal doesn't open
**Symptoms**: Drag group block, no modal appears
**Cause**: JavaScript error or modal element missing
**Solution**: Check browser console for errors, hard refresh (Ctrl+Shift+R)

### Issue: Approve button doesn't work
**Symptoms**: Click approve, nothing happens
**Cause**: Request ID not extracted correctly
**Solution**: Check notification link format, ensure it contains `change_request=UUID`

### Issue: Change not applied after all approvals
**Symptoms**: All members approved, schedule unchanged
**Cause**: Database update failed or RLS policy blocking
**Solution**: Check server logs for errors, verify RLS policies in Supabase

---

## ğŸ¯ Best Practices

### For Users
1. **Add reasons** when requesting group changes (helps others decide)
2. **Respond promptly** to change requests (they expire after 48h)
3. **Check constraints** before moving blocks (orange areas are blocked)
4. **Communicate** with your group outside the app for big changes

### For Developers
1. **Validate inputs** before sending to API
2. **Handle errors gracefully** (show user-friendly messages)
3. **Log all actions** for debugging
4. **Test with multiple users** (approval workflow requires it)

---

## ğŸ“ˆ Future Enhancements (Potential)

- [ ] Bulk move multiple blocks at once
- [ ] Copy/paste schedule blocks
- [ ] Suggest alternative times if drop fails
- [ ] Show approval status in real-time (who voted, who didn't)
- [ ] Allow requester to cancel pending requests
- [ ] Add expiration timer countdown in notifications
- [ ] Mobile touch support for drag-and-drop

---

## âœ¨ Summary

This system provides a **smooth, intuitive, and democratic** way to manage study schedules:

- **Personal blocks**: Instant flexibility
- **Group blocks**: Fair consensus process
- **Notifications**: Stay informed
- **Visual feedback**: Clear and intuitive

**Result**: Happy users, coordinated groups, optimized schedules! ğŸ‰

---

**Last Updated**: February 1, 2026
**Version**: 1.0
**Status**: âœ… Production Ready

