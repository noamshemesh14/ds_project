<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×™×•×¢×¥ ××§×“××™ ×—×›× - Student Planner</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            direction: rtl;
        }
        
        .navbar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .navbar-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
        }
        
        .nav-links {
            display: flex;
            gap: 2rem;
            list-style: none;
            align-items: center;
        }
        
        .nav-links a {
            text-decoration: none;
            color: #333;
            font-weight: 500;
            transition: color 0.3s;
            cursor: pointer;
        }
        
        .nav-links a:hover {
            color: #667eea;
        }
        
        .chat-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.2s;
        }
        
        .chat-btn:hover {
            transform: translateY(-2px);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .section {
            background: white;
            border-radius: 20px;
            padding: 3rem;
            margin-bottom: 3rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .section-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 3px solid #667eea;
        }
        
        .section-icon {
            font-size: 2.5em;
        }
        
        .section-title {
            font-size: 2em;
            color: #333;
        }
        
        .section-subtitle {
            color: #666;
            margin-top: 0.5rem;
        }
        
        /* Constraints Section */
        .constraints-section {
            background: #f8f9ff;
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
        }
        
        .constraints-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .constraints-title {
            font-size: 1.5em;
            color: #333;
            font-weight: bold;
        }
        
        .add-constraint-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s;
        }
        
        .add-constraint-btn:hover {
            background: #5568d3;
        }
        
        .constraints-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
        }
        
        .constraint-item {
            background: white;
            padding: 1rem;
            border-radius: 10px;
            border-right: 4px solid #667eea;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .constraint-info h4 {
            color: #333;
            margin-bottom: 0.25rem;
        }
        
        .constraint-info p {
            color: #666;
            font-size: 0.9em;
        }
        
        .constraint-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .btn-icon {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2em;
            color: #666;
            transition: color 0.3s;
        }
        
        .btn-icon:hover {
            color: #667eea;
        }
        
        /* Weekly Schedule */
        .week-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding: 1rem;
            background: #f8f9ff;
            border-radius: 15px;
        }
        
        .week-nav-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s;
        }
        
        .week-nav-btn:hover {
            background: #5568d3;
        }
        
        .week-title {
            font-size: 1.5em;
            color: #333;
            font-weight: bold;
        }
        
        .week-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1rem;
        }
        
        .day-column {
            background: #f8f9ff;
            border-radius: 10px;
            padding: 1rem;
            min-height: 400px;
        }
        
        .day-header {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #667eea;
            text-align: center;
        }
        
        .time-block {
            background: white;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: 8px;
            border-right: 4px solid #667eea;
            font-size: 0.9em;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .time-block:hover {
            transform: translateX(-3px);
        }
        
        .time-block.study {
            border-right-color: #4caf50;
        }
        
        .time-block.assignment {
            border-right-color: #ff9800;
        }
        
        .time-block.class {
            border-right-color: #2196f3;
        }
        
        .time-block.constraint {
            border-right-color: #9c27b0;
            background: #f3e5f5;
        }
        
        /* Assignments List */
        .assignments-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .assignment-item {
            background: #f8f9ff;
            padding: 1.5rem;
            border-radius: 10px;
            border-right: 4px solid #ff9800;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .assignment-item.urgent {
            border-right-color: #f44336;
        }
        
        .assignment-info h4 {
            color: #333;
            margin-bottom: 0.5rem;
        }
        
        .assignment-meta {
            color: #666;
            font-size: 0.9em;
        }
        
        .assignment-date {
            font-weight: bold;
            color: #667eea;
        }
        
        /* Grades Overview */
        .grades-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }
        
        .grade-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 15px;
            text-align: center;
        }
        
        .grade-value {
            font-size: 3em;
            font-weight: bold;
            margin: 1rem 0;
        }
        
        .grade-label {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        /* Floating Chat Widget */
        .chat-widget {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
        }
        
        .chat-toggle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            transition: transform 0.3s;
        }
        
        .chat-toggle:hover {
            transform: scale(1.1);
        }
        
        .chat-popup {
            position: fixed;
            bottom: 90px;
            left: 20px;
            width: 420px;
            height: 600px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            display: none;
            flex-direction: column;
            z-index: 1001;
        }
        
        .chat-popup.active {
            display: flex;
        }
        
        .chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chat-header-title {
            font-weight: bold;
        }
        
        .chat-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            background: #f8f9fa;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .message {
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .message.user {
            flex-direction: row-reverse;
        }
        
        .message-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 0.75em;
            flex-shrink: 0;
        }
        
        .message.user .message-avatar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .message.assistant .message-avatar {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .message-content {
            max-width: 80%;
            padding: 0.75rem 1rem;
            border-radius: 15px;
            font-size: 0.9em;
            line-height: 1.4;
            word-wrap: break-word;
        }
        
        .message.user .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-right-radius: 5px;
        }
        
        .message.assistant .message-content {
            background: white;
            color: #333;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-bottom-left-radius: 5px;
        }
        
        .empty-state {
            text-align: center;
            padding: 2rem 1rem;
            color: #999;
        }
        
        .empty-state p {
            margin: 0;
            font-size: 0.95em;
        }
        
        .loading-indicator {
            display: flex;
            gap: 0.4rem;
            padding: 0.75rem 1rem;
            background: white;
            border-radius: 15px;
            max-width: 80px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .loading-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #667eea;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        
        .loading-dot:nth-child(1) {
            animation-delay: -0.32s;
        }
        
        .loading-dot:nth-child(2) {
            animation-delay: -0.16s;
        }
        
        @keyframes bounce {
            0%, 80%, 100% {
                transform: scale(0);
            }
            40% {
                transform: scale(1);
            }
        }
        
        .error-message {
            background: #fee;
            color: #c33;
            padding: 0.75rem 1rem;
            border-radius: 10px;
            font-size: 0.85em;
            border-right: 3px solid #c33;
        }
        
        .chat-input-container {
            padding: 1rem;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 0.5rem;
        }
        
        .chat-input {
            flex: 1;
            padding: 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: 20px;
            font-size: 0.9em;
            outline: none;
            resize: none;
            max-height: 100px;
            font-family: inherit;
            transition: border-color 0.3s;
        }
        
        .chat-input:focus {
            border-color: #667eea;
        }
        
        .chat-input:disabled {
            background: #f5f5f5;
            cursor: not-allowed;
        }
        
        .chat-send-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 0.75rem 1.2rem;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.2s, opacity 0.2s;
            font-size: 0.9em;
        }
        
        .chat-send-btn:hover:not(:disabled) {
            transform: translateY(-2px);
        }
        
        .chat-send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .hidden {
            display: none;
        }
        
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            direction: rtl;
        }
        
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            direction: rtl;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #667eea;
            direction: rtl;
        }
        
        .modal-title {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 2em;
            cursor: pointer;
            color: #666;
        }
        
        .modal-close:hover {
            color: #333;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #333;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            font-family: inherit;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-start;
            margin-top: 2rem;
            direction: rtl;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 0.75rem 2rem;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.2s;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: #e0e0e0;
            color: #333;
            border: none;
            padding: 0.75rem 2rem;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .btn-secondary:hover {
            background: #d0d0d0;
        }
        
        .days-checkboxes {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .day-checkbox {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .day-checkbox input[type="checkbox"] {
            width: auto;
        }
        
        @media (max-width: 768px) {
            .week-grid {
                grid-template-columns: 1fr;
            }
            
            .chat-popup {
                width: calc(100% - 40px);
                left: 20px;
                right: 20px;
            }
        }
    </style>
    <style>
        /* Notifications Widget */
        .notifications-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            width: 350px;
            max-height: 500px;
            overflow-y: auto;
            z-index: 1000;
            margin-top: 0.5rem;
            direction: rtl;
        }
        
        .notifications-header {
            padding: 1rem;
            border-bottom: 2px solid #f0f0f0;
            font-weight: bold;
            background: #f8f9fa;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .btn-clear-notifications {
            background: #ff9800;
            color: white;
            border: none;
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
        }
        
        .btn-clear-notifications:hover {
            background: #f57c00;
        }
        
        .notifications-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .notification-item {
            padding: 1rem;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: start;
            gap: 0.5rem;
        }
        
        .notification-item:hover {
            background: #f8f9fa;
        }
        
        .notification-item.unread {
            background: #e3f2fd;
            font-weight: bold;
        }
        
        .notification-item.loading {
            text-align: center;
            color: #999;
            cursor: default;
        }
        
        .notification-title {
            font-weight: bold;
            margin-bottom: 0.25rem;
        }
        
        .notification-message {
            color: #666;
            font-size: 0.9em;
        }
        
        .notification-time {
            color: #999;
            font-size: 0.8em;
            margin-top: 0.25rem;
        }
        
        /* Modal for invitations */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            overflow: auto;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            max-width: 520px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.25);
            position: relative;
            direction: rtl;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .modal-header h3 {
            margin: 0;
            color: #333;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 2em;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .close-btn:hover {
            color: #333;
        }
        
        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 1.5rem;
        }
        
        .btn-primary {
            background: #4caf50;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .btn-primary:hover {
            background: #45a049;
        }
        
        .btn-secondary {
            background: #f44336;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .btn-secondary:hover {
            background: #da190b;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-content">
            <div class="logo">ğŸ“ ×™×•×¢×¥ ××§×“××™ ×—×›×</div>
            <ul class="nav-links">
                <li><a href="/profile">×¤×¨×•×¤×™×œ</a></li>
                <li><a href="/schedule">×‘× ×™×™×ª ××¢×¨×›×ª</a></li>
                <li><a href="/my-courses">ğŸ“š ×”×§×•×¨×¡×™× ×©×œ×™</a></li>
                <li id="notificationsWidget" style="position: relative;">
                    <button class="chat-btn" onclick="toggleNotifications()" id="notificationsBtn">ğŸ”” ×”×ª×¨××•×ª <span id="notificationBadge" style="display: none; background: #f44336; color: white; border-radius: 50%; padding: 0.2rem 0.5rem; font-size: 0.8em; margin-right: 0.5rem;">0</span></button>
                    <div id="notificationsDropdown" class="notifications-dropdown" style="display: none;">
                        <div class="notifications-header">
                            <span>×”×ª×¨××•×ª</span>
                            <button class="btn-clear-notifications" onclick="clearNotifications()" title="× ×§×” ×”×ª×¨××•×ª × ×§×¨××•×ª">ğŸ§¹ × ×§×” × ×§×¨××•×ª</button>
                        </div>
                        <div id="notificationsList" class="notifications-list">
                            <div class="notification-item loading">×˜×•×¢×Ÿ ×”×ª×¨××•×ª...</div>
                        </div>
                    </div>
                </li>
                <li id="authButton">
                    <button class="chat-btn" id="loginBtn" onclick="window.location.href='/login'">ğŸ” ×”×ª×—×‘×¨</button>
                </li>
                <li><button class="chat-btn" onclick="toggleChat()">ğŸ’¬ ×¦'××˜</button></li>
            </ul>
        </div>
    </nav>
    
    <div class="container">
        <!-- Constraints Section -->
        <section class="section">
            <div class="section-header">
                <div class="section-icon">âš™ï¸</div>
                <div>
                    <h2 class="section-title">××™×œ×•×¦×™× ×§×‘×•×¢×™×</h2>
                    <p class="section-subtitle">×”×’×“×¨ ××™×œ×•×¦×™× ×§×‘×•×¢×™× ×œ×ª×›× ×•×Ÿ ×”××¢×¨×›×ª ×•×”×œ×•"×– ×”×©×‘×•×¢×™</p>
                </div>
            </div>
            
            <div class="constraints-section">
                <div class="constraints-header">
                    <h3 class="constraints-title">×”××™×œ×•×¦×™× ×©×œ×™</h3>
                    <button class="add-constraint-btn" onclick="addConstraint()">+ ×”×•×¡×£ ××™×œ×•×¥</button>
                </div>
                <div class="constraints-list" id="constraintsList">
                    <p style="text-align: center; color: #666; padding: 2rem;">×˜×•×¢×Ÿ ××™×œ×•×¦×™×...</p>
                </div>
            </div>
        </section>
    </div>
    
    <!-- Floating Chat Widget -->
    <div class="chat-widget">
        <button class="chat-toggle" onclick="toggleChat()">ğŸ’¬</button>
        <div class="chat-popup" id="chatPopup">
            <div class="chat-header">
                <div class="chat-header-title">TechnionAI</div>
                <button class="chat-close" onclick="toggleChat()">Ã—</button>
            </div>
            <div class="chat-messages" id="chatMessages">
                <div class="empty-state">
                    <p>×× ×™ ×›××Ÿ ×œ×¢×–×•×¨ ×œ×š ×¢× ×©××œ×•×ª ××§×“××™×•×ª, × ×”×œ×™×, ×§×•×¨×¡×™× ×•×›×œ ××” ×©×§×©×•×¨ ×œ×˜×›× ×™×•×Ÿ.</p>
                </div>
            </div>
            <div class="chat-input-container">
                <textarea class="chat-input" id="chatInput" placeholder="×©××œ ××•×ª×™ ×›×œ ×©××œ×”..." rows="1"></textarea>
                <button class="chat-send-btn" id="chatSendBtn" onclick="sendChatMessage()">×©×œ×—</button>
            </div>
        </div>
    </div>
    
    <script>
        function toggleChat() {
            const popup = document.getElementById('chatPopup');
            if (popup) {
                popup.classList.toggle('active');
                if (popup.classList.contains('active')) {
                    // Focus input when opening
                    setTimeout(() => {
                        const input = document.getElementById('chatInput');
                        if (input) input.focus();
                    }, 100);
                }
            }
        }
        
        // Auto-resize textarea
        const chatInput = document.getElementById('chatInput');
        if (chatInput) {
            chatInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 100) + 'px';
            });
            
            // Send on Enter (Shift+Enter for new line)
            chatInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendChatMessage();
                }
            });
        }
        
        // Check authentication status
        checkAuthStatus();
        
        // Load constraints on page load
        loadConstraints();
        
        function checkAuthStatus() {
            const token = localStorage.getItem('auth_token');
            const authButton = document.getElementById('authButton');
            const loginBtn = document.getElementById('loginBtn');
            
            if (token) {
                // User is logged in - show ×”×ª× ×ª×§ on all pages
                loginBtn.textContent = 'ğŸšª ×”×ª× ×ª×§';
                loginBtn.onclick = function() {
                    if (confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×”×ª× ×ª×§?')) {
                        logout();
                    }
                };
            } else {
                // User is not logged in
                loginBtn.textContent = 'ğŸ” ×”×ª×—×‘×¨';
                loginBtn.onclick = function() {
                    window.location.href = '/login';
                };
            }
        }
        
        function logout() {
            localStorage.removeItem('auth_token');
            localStorage.removeItem('user_id');
            localStorage.removeItem('user_email');
            window.location.href = '/login';
        }
        
        // Chat functionality with RAG API
        let chatUserContext = null;
        let isChatLoading = false;
        
        // Load user context for chat
        async function loadChatUserContext() {
            try {
                const token = localStorage.getItem('auth_token') || localStorage.getItem('access_token');
                if (!token) {
                    console.warn('No auth token found for chat');
                    return;
                }
                
                const response = await fetch('/api/user/context', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    chatUserContext = await response.json();
                    console.log('Chat user context loaded:', chatUserContext);
                }
            } catch (error) {
                console.error('Error loading chat user context:', error);
            }
        }
        
        function addChatMessage(content, isUser = false) {
            const messagesDiv = document.getElementById('chatMessages');
            if (!messagesDiv) return;
            
            // Remove empty state
            const emptyState = messagesDiv.querySelector('.empty-state');
            if (emptyState) {
                emptyState.remove();
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'assistant'}`;
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = isUser ? '××ª×”' : 'AI';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.textContent = content;
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(contentDiv);
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        function showChatLoading() {
            const messagesDiv = document.getElementById('chatMessages');
            if (!messagesDiv) return;
            
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'message assistant';
            loadingDiv.id = 'chatLoadingMessage';
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = 'AI';
            
            const loadingIndicator = document.createElement('div');
            loadingIndicator.className = 'loading-indicator';
            loadingIndicator.innerHTML = `
                <div class="loading-dot"></div>
                <div class="loading-dot"></div>
                <div class="loading-dot"></div>
            `;
            
            loadingDiv.appendChild(avatar);
            loadingDiv.appendChild(loadingIndicator);
            messagesDiv.appendChild(loadingDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        function removeChatLoading() {
            const loadingMessage = document.getElementById('chatLoadingMessage');
            if (loadingMessage) {
                loadingMessage.remove();
            }
        }
        
        function showChatError(message) {
            const messagesDiv = document.getElementById('chatMessages');
            if (!messagesDiv) return;
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = `×©×’×™××”: ${message}`;
            messagesDiv.appendChild(errorDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const sendBtn = document.getElementById('chatSendBtn');
            if (!input || !sendBtn) return;
            
            const message = input.value.trim();
            if (!message || isChatLoading) {
                return;
            }
            
            // Add user message
            addChatMessage(message, true);
            input.value = '';
            input.style.height = 'auto';
            
            // Disable input
            isChatLoading = true;
            input.disabled = true;
            sendBtn.disabled = true;
            
            // Show loading
            showChatLoading();
            
            try {
                const token = localStorage.getItem('auth_token') || localStorage.getItem('access_token');
                if (!token) {
                    throw new Error('×œ× ××—×•×‘×¨. ×× × ×”×ª×—×‘×¨ ×ª×—×™×œ×”.');
                }
                
                // Load user context if not loaded
                if (!chatUserContext) {
                    await loadChatUserContext();
                }
                
                const response = await fetch('/api/execute', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        prompt: message,
                        user_context: chatUserContext,
                        ui_context: {
                            source: 'free_text'
                        }
                    })
                });
                
                // Check if response is OK
                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                        throw new Error('×”×˜×•×§×Ÿ ×¤×’ ×ª×•×§×£. ×× × ×”×ª×—×‘×¨ ××—×“×©.');
                    }
                    const errorData = await response.json().catch(() => ({ detail: '×©×’×™××ª ×©×¨×ª' }));
                    throw new Error(errorData.detail || `×©×’×™××ª ×©×¨×ª: ${response.status}`);
                }
                
                const data = await response.json();
                
                removeChatLoading();
                
                if (data.status === 'ok' || data.status === 'success') {
                    addChatMessage(data.response || '×ª×©×•×‘×” ×”×ª×§×‘×œ×” ×‘×”×¦×œ×—×”');
                } else {
                    const errorMsg = data.error || '××™×¨×¢×” ×©×’×™××” ×‘×¢×ª ×©×œ×™×—×ª ×”×”×•×“×¢×”';
                    showChatError(errorMsg);
                }
            } catch (error) {
                removeChatLoading();
                const errorMsg = error.message || '××™×¨×¢×” ×©×’×™××” ×‘×¢×ª ×©×œ×™×—×ª ×”×”×•×“×¢×”';
                showChatError(errorMsg);
                console.error('Chat error:', error);
                
                // If authentication error, suggest re-login
                if (errorMsg.includes('×¤×’ ×ª×•×§×£') || errorMsg.includes('401') || errorMsg.includes('403')) {
                    setTimeout(() => {
                        if (confirm('×”×˜×•×§×Ÿ ×¤×’ ×ª×•×§×£. ×”×× ×ª×¨×¦×” ×œ×”×ª×—×‘×¨ ××—×“×©?')) {
                            window.location.href = '/login';
                        }
                    }, 1000);
                }
            } finally {
                // Re-enable input
                isChatLoading = false;
                input.disabled = false;
                sendBtn.disabled = false;
                input.focus();
            }
        }
        
        // Load user context when chat popup is opened
        document.addEventListener('DOMContentLoaded', function() {
            const chatPopup = document.getElementById('chatPopup');
            if (chatPopup) {
                const observer = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                            if (chatPopup.classList.contains('active') && !chatUserContext) {
                                loadChatUserContext();
                            }
                        }
                    });
                });
                observer.observe(chatPopup, { attributes: true });
            }
        });
        
        // Constraints management
        let constraints = [];
        let editingConstraintId = null;
        
        async function loadConstraints() {
            try {
                const token = localStorage.getItem('auth_token');
                const headers = {
                    'Content-Type': 'application/json'
                };
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }
                
                const response = await fetch('/api/constraints', {
                    headers: headers
                });
                
                if (response.ok) {
                    const data = await response.json();
                    constraints = data.constraints || [];
                    renderConstraints();
                } else if (response.status === 401) {
                    // Not authenticated - show empty list
                    constraints = [];
                    renderConstraints();
                }
            } catch (error) {
                console.error('Error loading constraints:', error);
                // If not authenticated, just show empty list
                constraints = [];
                renderConstraints();
            }
        }
        
        function renderConstraints() {
            const constraintsList = document.getElementById('constraintsList');
            if (!constraintsList) return;
            
            if (constraints.length === 0) {
                constraintsList.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">××™×Ÿ ××™×œ×•×¦×™×. ×œ×—×¥ ×¢×œ "×”×•×¡×£ ××™×œ×•×¥" ×›×“×™ ×œ×”×ª×—×™×œ.</p>';
                return;
            }
            
            constraintsList.innerHTML = constraints.map((constraint, index) => {
                const daysList = constraint.days.split(',').map(d => d.trim()).join(', ');
                return `
                    <div class="constraint-item">
                        <div class="constraint-info">
                            <h4>${constraint.title}</h4>
                            <p>${daysList}, ${constraint.start_time}-${constraint.end_time}${constraint.description ? '<br>' + constraint.description : ''}</p>
                        </div>
                        <div class="constraint-actions">
                            <button class="btn-icon" onclick="editConstraint('${constraint.id}')">âœï¸</button>
                            <button class="btn-icon" onclick="deleteConstraint('${constraint.id}')">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function addConstraint() {
            editingConstraintId = null;
            openConstraintModal();
        }
        
        function editConstraint(constraintId) {
            editingConstraintId = constraintId;
            const constraint = constraints.find(c => c.id === constraintId);
            if (!constraint) return;
            
            openConstraintModal(constraint);
        }
        
        function openConstraintModal(constraint = null) {
            const modal = document.getElementById('constraintModal');
            const form = document.getElementById('constraintForm');
            
            if (constraint) {
                document.getElementById('constraintTitle').value = constraint.title;
                document.getElementById('constraintDescription').value = constraint.description || '';
                document.getElementById('constraintStartTime').value = constraint.start_time;
                document.getElementById('constraintEndTime').value = constraint.end_time;
                
                // Set checkboxes for days
                const days = constraint.days.split(',').map(d => d.trim());
                const dayNames = ['×¨××©×•×Ÿ', '×©× ×™', '×©×œ×™×©×™', '×¨×‘×™×¢×™', '×—××™×©×™', '×©×™×©×™', '×©×‘×ª'];
                dayNames.forEach((day, index) => {
                    const checkbox = document.getElementById(`day${index}`);
                    if (checkbox) {
                        checkbox.checked = days.includes(day);
                    }
                });
            } else {
                form.reset();
            }
            
            modal.classList.add('active');
        }
        
        function closeConstraintModal() {
            const modal = document.getElementById('constraintModal');
            modal.classList.remove('active');
            editingConstraintId = null;
        }
        
        async function saveConstraint() {
            const title = document.getElementById('constraintTitle').value.trim();
            const description = document.getElementById('constraintDescription').value.trim();
            const startTime = document.getElementById('constraintStartTime').value;
            const endTime = document.getElementById('constraintEndTime').value;
            
            if (!title || !startTime || !endTime) {
                alert('×× × ××œ× ××ª ×›×œ ×”×©×“×•×ª ×”× ×“×¨×©×™×');
                return;
            }
            
            // Get selected days
            const dayNames = ['×¨××©×•×Ÿ', '×©× ×™', '×©×œ×™×©×™', '×¨×‘×™×¢×™', '×—××™×©×™', '×©×™×©×™', '×©×‘×ª'];
            const selectedDays = [];
            dayNames.forEach((day, index) => {
                const checkbox = document.getElementById(`day${index}`);
                if (checkbox && checkbox.checked) {
                    selectedDays.push(day);
                }
            });
            
            if (selectedDays.length === 0) {
                alert('×× × ×‘×—×¨ ×œ×¤×—×•×ª ×™×•× ××—×“');
                return;
            }
            
            const constraintData = {
                title: title,
                description: description || null,
                days: selectedDays.join(','),
                start_time: startTime,
                end_time: endTime,
                is_hard: true
            };
            
            try {
                const token = localStorage.getItem('auth_token');
                const headers = {
                    'Content-Type': 'application/json'
                };
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }
                
                let response;
                if (editingConstraintId) {
                    response = await fetch(`/api/constraints/${editingConstraintId}`, {
                        method: 'PUT',
                        headers: headers,
                        body: JSON.stringify(constraintData)
                    });
                } else {
                    response = await fetch('/api/constraints', {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify(constraintData)
                    });
                }
                
                if (!response.ok) {
                    if (response.status === 401) {
                        alert('×× × ×”×ª×—×‘×¨ ×›×“×™ ×œ×©××•×¨ ××™×œ×•×¦×™×');
                        return;
                    }
                    throw new Error('×©×’×™××” ×‘×©××™×¨×ª ×”××™×œ×•×¥');
                }
                
                closeConstraintModal();
                await loadConstraints();
            } catch (error) {
                console.error('Error saving constraint:', error);
                alert('×©×’×™××” ×‘×©××™×¨×ª ×”××™×œ×•×¥. ×× × × ×¡×” ×©×•×‘.');
            }
        }
        
        async function deleteConstraint(constraintId) {
            if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××™×œ×•×¥ ×–×”?')) {
                return;
            }
            
            try {
                const token = localStorage.getItem('auth_token');
                const headers = {
                    'Content-Type': 'application/json'
                };
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }
                
                const response = await fetch(`/api/constraints/${constraintId}`, {
                    method: 'DELETE',
                    headers: headers
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        alert('×× × ×”×ª×—×‘×¨ ×›×“×™ ×œ××—×•×§ ××™×œ×•×¦×™×');
                        return;
                    }
                    throw new Error('×©×’×™××” ×‘××—×™×§×ª ×”××™×œ×•×¥');
                }
                
                await loadConstraints();
            } catch (error) {
                console.error('Error deleting constraint:', error);
                alert('×©×’×™××” ×‘××—×™×§×ª ×”××™×œ×•×¥. ×× × × ×¡×” ×©×•×‘.');
            }
        }
    </script>
    
    <script>
        // Notifications functionality for index.html
        let notifications = [];
        let currentInvitationId = null;
        
        async function loadNotifications() {
            const token = localStorage.getItem('auth_token');
            if (!token) return;
            
            try {
                const response = await fetch('/api/notifications', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    notifications = data.notifications || [];
                    updateNotificationsUI();
                }
            } catch (error) {
                console.error('Error loading notifications:', error);
            }
        }
        
        function updateNotificationsUI() {
            const badge = document.getElementById('notificationBadge');
            const unreadCount = notifications.filter(n => !n.read).length;
            
            if (badge) {
                if (unreadCount > 0) {
                    badge.textContent = unreadCount;
                    badge.style.display = 'inline-block';
                } else {
                    badge.style.display = 'none';
                }
            }
            
            const list = document.getElementById('notificationsList');
            if (list) {
                if (notifications.length === 0) {
                    list.innerHTML = '<div class="notification-item loading">××™×Ÿ ×”×ª×¨××•×ª</div>';
                } else {
                    list.innerHTML = notifications.map(notif => {
                        const time = new Date(notif.created_at).toLocaleString('he-IL');
                        return `
                            <div class="notification-item ${!notif.read ? 'unread' : ''}" style="display: flex; justify-content: space-between; align-items: start; gap: 0.5rem;">
                                <div onclick="handleNotificationClick('${notif.id}', '${notif.type}', '${notif.link || ''}')" style="flex: 1; cursor: pointer;">
                                    <div class="notification-title">${notif.title}</div>
                                    <div class="notification-message">${notif.message}</div>
                                    <div class="notification-time">${time}</div>
                                </div>
                                <button onclick="event.stopPropagation(); if(confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ×”×ª×¨××” ×–×•?')) deleteNotification('${notif.id}')" style="background: #f44336; color: white; border: none; padding: 0.3rem 0.6rem; border-radius: 4px; cursor: pointer; font-size: 0.8em; flex-shrink: 0;" title="××—×§ ×”×ª×¨××”">Ã—</button>
                            </div>
                        `;
                    }).join('');
                }
            }
        }
        
        function toggleNotifications() {
            const dropdown = document.getElementById('notificationsDropdown');
            if (dropdown) {
                if (dropdown.style.display === 'none') {
                    dropdown.style.display = 'block';
                    loadNotifications();
                } else {
                    dropdown.style.display = 'none';
                }
            }
        }
        
        async function handleNotificationClick(notificationId, type, link) {
            const token = localStorage.getItem('auth_token');
            if (!token) return;
            
            // Handle based on type FIRST (before marking as read)
            // This way if there's an error, the notification stays visible
            if (type === 'group_invitation') {
                // Try to get invitation_id by notification_id (most reliable)
                let invitationId = null;
                
                try {
                    const invResponse = await fetch(`/api/groups/invitations/by-notification/${notificationId}`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    if (invResponse.ok) {
                        const invData = await invResponse.json();
                        invitationId = invData.invitation_id;
                        console.log('âœ… Found invitation_id:', invitationId);
                    } else {
                        const errorText = await invResponse.text();
                        console.error('âŒ Failed to get invitation by notification:', invResponse.status, errorText);
                    }
                } catch (error) {
                    console.error('Error getting invitation by notification:', error);
                }
                
                // Fallback: try to extract from link
                if (!invitationId && link) {
                    const invitationMatch = link.match(/invitation=([^&]+)/);
                    if (invitationMatch) {
                        invitationId = invitationMatch[1];
                    } else {
                        // If no invitation_id in link, try to get it by group_id
                        const groupMatch = link.match(/group=([^&]+)/);
                        if (groupMatch) {
                            const groupId = groupMatch[1];
                            try {
                                const invResponse = await fetch(`/api/groups/invitations/by-group/${groupId}`, {
                                    headers: {
                                        'Authorization': `Bearer ${token}`
                                    }
                                });
                                if (invResponse.ok) {
                                    const invData = await invResponse.json();
                                    invitationId = invData.invitation_id;
                                } else {
                                    console.error('Failed to get invitation by group:', await invResponse.text());
                                }
                            } catch (error) {
                                console.error('Error getting invitation by group:', error);
                            }
                        }
                    }
                }
                
                if (invitationId) {
                    showInvitationDialog(invitationId);
                } else {
                    console.error('âŒ Could not find invitation_id for notification:', notificationId);
                    alert('×œ× × ××¦××” ×”×–×× ×”. ×™×™×ª×›×Ÿ ×©×”×”×–×× ×” ×›×‘×¨ ×˜×•×¤×œ×” ××• × ××—×§×”. ×× × ×¨×¢× ×Ÿ ××ª ×”×“×£.');
                }
            } else if (link) {
                window.location.href = link;
            }
            
            // Mark as read when clicked (but don't delete - user can delete manually)
            // This updates the unread count badge
            try {
                await fetch(`/api/notifications/${notificationId}/read`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                // Reload notifications to update the badge count
                await loadNotifications();
            } catch (error) {
                console.error('Error marking notification as read:', error);
            }
        }
        
        async function showInvitationDialog(invitationId) {
            currentInvitationId = invitationId;
            
            // Get invitation details
            const token = localStorage.getItem('auth_token');
            if (!token) return;
            
            try {
                // Get notification details to show message
                const notifResponse = await fetch('/api/notifications', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (notifResponse.ok) {
                    const notifData = await notifResponse.json();
                    const notification = notifData.notifications.find(n => {
                        if (n.link) {
                            const match = n.link.match(/invitation=([^&]+)/);
                            return match && match[1] === invitationId;
                        }
                        return false;
                    });
                    
                    if (notification) {
                        document.getElementById('invitationMessage').textContent = notification.message;
                    } else {
                        document.getElementById('invitationMessage').textContent = '×”×ª×§×‘×œ×” ×”×–×× ×” ×œ×”×¦×˜×¨×£ ×œ×§×‘×•×¦×ª ×œ×™××•×“';
                    }
                }
            } catch (error) {
                console.error('Error loading invitation details:', error);
                document.getElementById('invitationMessage').textContent = '×”×ª×§×‘×œ×” ×”×–×× ×” ×œ×”×¦×˜×¨×£ ×œ×§×‘×•×¦×ª ×œ×™××•×“';
            }
            
            // Show modal
            const modal = document.getElementById('invitationModal');
            if (modal) {
                modal.classList.add('active');
            }
        }
        
        function closeInvitationModal() {
            const modal = document.getElementById('invitationModal');
            if (modal) {
                modal.classList.remove('active');
            }
            currentInvitationId = null;
        }
        
        async function acceptInvitationFromModal() {
            if (currentInvitationId) {
                // Save the ID before closing the modal (which sets it to null)
                const invitationId = currentInvitationId;
                closeInvitationModal();
                await acceptInvitation(invitationId);
            } else {
                console.error('No invitation ID available');
                alert('×©×’×™××”: ×œ× × ××¦× ××–×”×” ×”×–×× ×”');
            }
        }
        
        async function rejectInvitationFromModal() {
            if (currentInvitationId) {
                // Save the ID before closing the modal (which sets it to null)
                const invitationId = currentInvitationId;
                closeInvitationModal();
                await rejectInvitation(invitationId);
            } else {
                console.error('No invitation ID available');
            }
        }
        
        async function acceptInvitation(invitationId) {
            const token = localStorage.getItem('auth_token');
            if (!token) {
                alert('×× × ×”×ª×—×‘×¨ ×›×“×™ ×œ×”×¦×˜×¨×£ ×œ×§×‘×•×¦×”');
                return;
            }
            
            try {
                const response = await fetch(`/api/groups/invitations/${invitationId}/accept`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    alert('âœ… ×”×¦×˜×¨×¤×ª ×‘×”×¦×œ×—×” ×œ×§×‘×•×¦×”!');
                    // Reload notifications - notification stays visible until user deletes it
                    await loadNotifications();
                    // Close modal
                    closeInvitationModal();
                } else {
                    const errorData = await response.json();
                    const errorMsg = errorData.detail || '×œ× × ×™×ª×Ÿ ×œ×”×¦×˜×¨×£ ×œ×§×‘×•×¦×”';
                    console.error('Error accepting invitation:', errorMsg);
                    alert('×©×’×™××”: ' + errorMsg);
                    // Reload notifications to make sure it's still visible
                    await loadNotifications();
                }
            } catch (error) {
                console.error('Error accepting invitation:', error);
                alert('×©×’×™××” ×‘×”×¦×˜×¨×¤×•×ª ×œ×§×‘×•×¦×”. ×× × × ×¡×” ×©×•×‘ ××• ×¨×¢× ×Ÿ ××ª ×”×“×£.');
            }
        }
        
        async function rejectInvitation(invitationId) {
            const token = localStorage.getItem('auth_token');
            if (!token) return;
            
            try {
                const response = await fetch(`/api/groups/invitations/${invitationId}/reject`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    alert('×”×–×× ×” × ×“×—×ª×”');
                    await loadNotifications();
                }
            } catch (error) {
                console.error('Error rejecting invitation:', error);
            }
        }
        
        async function deleteNotification(notificationId) {
            const token = localStorage.getItem('auth_token');
            if (!token) return;
            
            try {
                const response = await fetch(`/api/notifications/${notificationId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    await loadNotifications();
                } else {
                    const error = await response.json();
                    alert('×©×’×™××”: ' + (error.detail || '×œ× × ×™×ª×Ÿ ×œ××—×•×§ ×”×ª×¨××”'));
                }
            } catch (error) {
                console.error('Error deleting notification:', error);
                alert('×©×’×™××” ×‘××—×™×§×ª ×”×ª×¨××”');
            }
        }
        
        async function clearNotifications() {
            if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×›×œ ×”×”×ª×¨××•×ª ×”× ×§×¨××•×ª?')) {
                return;
            }
            
            const token = localStorage.getItem('auth_token');
            if (!token) {
                alert('×× × ×”×ª×—×‘×¨ ×›×“×™ ×œ× ×§×•×ª ×”×ª×¨××•×ª');
                return;
            }
            
            try {
                const response = await fetch('/api/notifications?read_only=true', {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    alert('âœ… ×”×”×ª×¨××•×ª ×”× ×§×¨××•×ª × ××—×§×•');
                    await loadNotifications();
                } else {
                    const error = await response.json();
                    alert('×©×’×™××”: ' + (error.detail || '×œ× × ×™×ª×Ÿ ×œ××—×•×§ ×”×ª×¨××•×ª'));
                }
            } catch (error) {
                console.error('Error clearing notifications:', error);
                alert('×©×’×™××” ×‘××—×™×§×ª ×”×ª×¨××•×ª');
            }
        }
        
        // Load notifications on page load
        if (localStorage.getItem('auth_token')) {
            loadNotifications();
            // Load notifications every 60 seconds (reduced frequency to avoid issues)
            setInterval(() => {
                if (localStorage.getItem('auth_token')) {
                    loadNotifications();
                }
            }, 60000);
        }
    </script>
    
    <!-- Constraint Modal -->
    <div id="constraintModal" class="modal" onclick="if(event.target.id === 'constraintModal') closeConstraintModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">×”×•×¡×£ ××™×œ×•×¥</h2>
                <button class="modal-close" onclick="closeConstraintModal()">Ã—</button>
            </div>
            <form id="constraintForm" onsubmit="event.preventDefault(); saveConstraint();">
                <div class="form-group">
                    <label for="constraintTitle">×©× ×”××™×œ×•×¥ *</label>
                    <input type="text" id="constraintTitle" required placeholder="×œ××©×œ: ×¢×‘×•×“×”, ××™××•×Ÿ">
                </div>
                <div class="form-group">
                    <label for="constraintDescription">×ª×™××•×¨ (××•×¤×¦×™×•× ×œ×™)</label>
                    <textarea id="constraintDescription" placeholder="×ª×™××•×¨ × ×•×¡×£ ×©×œ ×”××™×œ×•×¥"></textarea>
                </div>
                <div class="form-group">
                    <label>×™××™× ×‘×©×‘×•×¢ *</label>
                    <div class="days-checkboxes">
                        <div class="day-checkbox">
                            <input type="checkbox" id="day0" value="×¨××©×•×Ÿ">
                            <label for="day0">×¨××©×•×Ÿ</label>
                        </div>
                        <div class="day-checkbox">
                            <input type="checkbox" id="day1" value="×©× ×™">
                            <label for="day1">×©× ×™</label>
                        </div>
                        <div class="day-checkbox">
                            <input type="checkbox" id="day2" value="×©×œ×™×©×™">
                            <label for="day2">×©×œ×™×©×™</label>
                        </div>
                        <div class="day-checkbox">
                            <input type="checkbox" id="day3" value="×¨×‘×™×¢×™">
                            <label for="day3">×¨×‘×™×¢×™</label>
                        </div>
                        <div class="day-checkbox">
                            <input type="checkbox" id="day4" value="×—××™×©×™">
                            <label for="day4">×—××™×©×™</label>
                        </div>
                        <div class="day-checkbox">
                            <input type="checkbox" id="day5" value="×©×™×©×™">
                            <label for="day5">×©×™×©×™</label>
                        </div>
                        <div class="day-checkbox">
                            <input type="checkbox" id="day6" value="×©×‘×ª">
                            <label for="day6">×©×‘×ª</label>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="constraintStartTime">×©×¢×ª ×”×ª×—×œ×” *</label>
                    <select id="constraintStartTime" required style="width: 100%; padding: 0.75rem; border: 2px solid #ddd; border-radius: 8px; font-size: 1em;">
                        <option value="00:00">00:00</option>
                        <option value="01:00">01:00</option>
                        <option value="02:00">02:00</option>
                        <option value="03:00">03:00</option>
                        <option value="04:00">04:00</option>
                        <option value="05:00">05:00</option>
                        <option value="06:00">06:00</option>
                        <option value="07:00">07:00</option>
                        <option value="08:00">08:00</option>
                        <option value="09:00">09:00</option>
                        <option value="10:00">10:00</option>
                        <option value="11:00">11:00</option>
                        <option value="12:00">12:00</option>
                        <option value="13:00">13:00</option>
                        <option value="14:00">14:00</option>
                        <option value="15:00">15:00</option>
                        <option value="16:00">16:00</option>
                        <option value="17:00">17:00</option>
                        <option value="18:00">18:00</option>
                        <option value="19:00">19:00</option>
                        <option value="20:00">20:00</option>
                        <option value="21:00">21:00</option>
                        <option value="22:00">22:00</option>
                        <option value="23:00">23:00</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="constraintEndTime">×©×¢×ª ×¡×™×•× *</label>
                    <select id="constraintEndTime" required style="width: 100%; padding: 0.75rem; border: 2px solid #ddd; border-radius: 8px; font-size: 1em;">
                        <option value="00:00">00:00</option>
                        <option value="01:00">01:00</option>
                        <option value="02:00">02:00</option>
                        <option value="03:00">03:00</option>
                        <option value="04:00">04:00</option>
                        <option value="05:00">05:00</option>
                        <option value="06:00">06:00</option>
                        <option value="07:00">07:00</option>
                        <option value="08:00">08:00</option>
                        <option value="09:00">09:00</option>
                        <option value="10:00">10:00</option>
                        <option value="11:00">11:00</option>
                        <option value="12:00">12:00</option>
                        <option value="13:00">13:00</option>
                        <option value="14:00">14:00</option>
                        <option value="15:00">15:00</option>
                        <option value="16:00">16:00</option>
                        <option value="17:00">17:00</option>
                        <option value="18:00">18:00</option>
                        <option value="19:00">19:00</option>
                        <option value="20:00">20:00</option>
                        <option value="21:00">21:00</option>
                        <option value="22:00">22:00</option>
                        <option value="23:00">23:00</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="closeConstraintModal()">×‘×™×˜×•×œ</button>
                    <button type="submit" class="btn-primary">×©××•×¨</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Invitation Dialog Modal -->
    <div id="invitationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>×”×–×× ×” ×œ×§×‘×•×¦×ª ×œ×™××•×“</h3>
                <button class="close-btn" onclick="closeInvitationModal()">Ã—</button>
            </div>
            <div id="invitationModalBody" style="padding: 1.5rem 0;">
                <p id="invitationMessage"></p>
            </div>
            <div class="modal-actions">
                <button class="btn-primary" onclick="acceptInvitationFromModal()" id="acceptInvitationBtn">âœ… ×§×‘×œ ×”×–×× ×”</button>
                <button class="btn-secondary" onclick="rejectInvitationFromModal()" id="rejectInvitationBtn">âŒ ×“×—×” ×”×–×× ×”</button>
            </div>
        </div>
    </div>
</body>
</html>
