<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×”×§×•×¨×¡×™× ×©×œ×™ - Student Planner</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            direction: rtl;
        }
        
        .navbar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .navbar-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
        }
        
        .nav-links {
            display: flex;
            gap: 2rem;
            list-style: none;
            align-items: center;
        }
        
        .nav-links a {
            text-decoration: none;
            color: #333;
            font-weight: 500;
            transition: color 0.3s;
        }
        
        .nav-links a:hover {
            color: #667eea;
        }
        
        .chat-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.2s;
        }
        
        .chat-btn:hover {
            transform: translateY(-2px);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .section {
            background: white;
            border-radius: 20px;
            padding: 3rem;
            margin-bottom: 3rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .section-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 3px solid #667eea;
        }
        
        .section-icon {
            font-size: 2.5em;
        }
        
        .section-title {
            font-size: 2em;
            color: #333;
        }
        
        .section-subtitle {
            color: #666;
            margin-top: 0.5rem;
        }
        
        /* Course Tabs */
        .course-tabs-container {
            margin-top: 2rem;
        }
        
        .course-tabs {
            display: flex;
            gap: 0.5rem;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 2rem;
            overflow-x: auto;
            padding-bottom: 0.5rem;
        }
        
        .course-tab {
            padding: 0.75rem 1.5rem;
            background: #f5f5f5;
            border: 2px solid transparent;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-weight: 500;
            color: #666;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .course-tab:hover {
            background: #e8e8e8;
        }
        
        .course-tab.active {
            background: white;
            border-color: #667eea;
            border-bottom-color: white;
            color: #667eea;
            font-weight: bold;
        }
        
        .course-tab-content {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            padding: 2rem;
            min-height: 400px;
        }
        
        .course-tab-panel {
            display: none;
        }
        
        .course-tab-panel.active {
            display: block;
        }
        
        /* My Courses Section */
        .my-course-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }
        
        .my-course-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-color: #667eea;
        }
        
        .my-course-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .my-course-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
        }
        
        .my-course-number {
            color: #666;
            font-size: 0.9em;
            margin-right: 0.5rem;
        }
        
        .my-course-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .my-course-field {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .my-course-field-label {
            font-size: 0.85em;
            color: #666;
            font-weight: 500;
        }
        
        .my-course-field-value {
            font-size: 1em;
            color: #333;
        }
        
        .semester-selector {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 2px solid #f0f0f0;
        }
        
        .semester-selector label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #333;
        }
        
        .semester-selector select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            direction: rtl;
            cursor: pointer;
            transition: border-color 0.3s;
        }
        
        .semester-selector select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .semester-selector select:hover {
            border-color: #667eea;
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #666;
        }
        
        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 1rem;
        }
        
        .grade-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
            direction: ltr;
            unicode-bidi: embed;
            text-align: center;
            min-width: 50px;
        }
        
        .grade-excellent {
            background: #4caf50;
            color: white;
        }
        
        .grade-good {
            background: #8bc34a;
            color: white;
        }
        
        .grade-average {
            background: #ffc107;
            color: #333;
        }
        
        .grade-low {
            background: #ff9800;
            color: white;
        }
        
        /* Modal positioning */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            overflow: auto;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            max-width: 560px;
            width: 92%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.25);
            position: relative;
            direction: rtl;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .modal-header h3 {
            margin: 0;
            color: #333;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 2em;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .close-btn:hover {
            color: #333;
        }
        
        /* Form layout */
        .modal form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .form-group {
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
        }
        
        .form-group label {
            font-weight: 600;
            color: #333;
        }
        
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            direction: rtl;
        }
        
        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .invite-emails {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .email-input-row {
            display: flex;
            gap: 0.5rem;
        }
        
        .email-input-row input {
            flex: 1;
        }

        .btn-remove-email {
            background: #f44336;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
        }

        .btn-add-email {
            background: #4caf50;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 0.5rem;
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 0.5rem;
        }
        
        .days {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .day-tag {
            background: #e3f2fd;
            color: #1976d2;
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.85em;
        }
        
        .time-info {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        /* Groups */
        .groups-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .group-card {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 1rem;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }
        
        .group-card:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }
        
        .btn-delete-group {
            flex-shrink: 0;
        }
        
        .btn-delete-group:hover {
            background: #d32f2f !important;
        }
        
        .group-name {
            font-weight: bold;
            font-size: 1.1em;
            color: #333;
            margin-bottom: 0.5rem;
        }
        
        .group-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.9em;
            color: #666;
        }
        
        /* Notifications Widget */
        .notifications-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            width: 350px;
            max-height: 500px;
            overflow-y: auto;
            z-index: 1000;
            margin-top: 0.5rem;
            direction: rtl;
        }
        
        .notifications-header {
            padding: 1rem;
            border-bottom: 2px solid #f0f0f0;
            font-weight: bold;
            background: #f8f9fa;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .btn-clear-notifications {
            background: #ff9800;
            color: white;
            border: none;
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
        }
        
        .btn-clear-notifications:hover {
            background: #f57c00;
        }
        
        .notifications-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .notification-item {
            padding: 1rem;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .notification-item:hover {
            background: #f8f9fa;
        }
        
        .notification-item.unread {
            background: #e3f2fd;
            font-weight: bold;
        }
        
        .notification-item.loading {
            text-align: center;
            color: #999;
            cursor: default;
        }
        
        .notification-title {
            font-weight: bold;
            margin-bottom: 0.25rem;
        }
        
        .notification-message {
            color: #666;
            font-size: 0.9em;
        }
        
        .notification-time {
            color: #999;
            font-size: 0.8em;
            margin-top: 0.25rem;
        }
        
        /* Assignments Section */
        .assignments-section {
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 2px solid #f0f0f0;
        }
        
        .assignments-header {
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .assignments-header h3 {
            margin-bottom: 0.5rem;
            color: #333;
        }
        
        .add-assignment-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .add-assignment-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .assignment-card {
            background: #f8f9fa;
            border-right: 4px solid;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 1rem;
        }
        
        .assignment-card:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transform: translateX(-2px);
        }
        
        .assignment-card.high-priority {
            border-right-color: #f44336;
            background: #ffebee;
        }
        
        .assignment-card.medium-priority {
            border-right-color: #ff9800;
            background: #fff3e0;
        }
        
        .assignment-card.low-priority {
            border-right-color: #4caf50;
            background: #f1f8e9;
        }
        
        .assignment-card.completed {
            opacity: 0.6;
            text-decoration: line-through;
        }
        
        .assignment-info {
            flex: 1;
        }
        
        .assignment-title {
            font-weight: bold;
            font-size: 1em;
            margin-bottom: 0.3rem;
            color: #333;
        }
        
        .assignment-description {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 0.5rem;
        }
        
        .assignment-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.85em;
            flex-wrap: wrap;
        }
        
        .assignment-due-date {
            color: #666;
        }
        
        .days-remaining {
            font-weight: bold;
            padding: 0.2rem 0.6rem;
            border-radius: 4px;
            white-space: nowrap;
        }
        
        .days-urgent {
            background: #f44336;
            color: white;
        }
        
        .days-soon {
            background: #ff9800;
            color: white;
        }
        
        .days-plenty {
            background: #4caf50;
            color: white;
        }
        
        .days-overdue {
            background: #d32f2f;
            color: white;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.7;
            }
        }
        
        .assignment-priority {
            padding: 0.2rem 0.6rem;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
            white-space: nowrap;
        }
        
        .priority-high {
            background: #f44336;
            color: white;
        }
        
        .priority-medium {
            background: #ff9800;
            color: white;
        }
        
        .priority-low {
            background: #4caf50;
            color: white;
        }
        
        .assignment-status {
            flex-shrink: 0;
        }
        
        .assignment-checkbox {
            width: 24px;
            height: 24px;
            cursor: pointer;
            accent-color: #667eea;
        }
        
        .empty-assignments {
            text-align: center;
            padding: 2rem;
            color: #999;
            background: #f5f5f5;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-content">
            <div class="logo">ğŸ“ ×™×•×¢×¥ ××§×“××™ ×—×›×</div>
            <ul class="nav-links">
                <li><a href="/">×™×•×¢×¥ ××§×“××™</a></li>
                <li><a href="/profile">×¤×¨×•×¤×™×œ</a></li>
                <li><a href="/schedule">×‘× ×™×™×ª ××¢×¨×›×ª</a></li>
                <li><a href="/my-courses" style="color: #667eea; font-weight: bold;">ğŸ“š ×”×§×•×¨×¡×™× ×©×œ×™</a></li>
                <li id="notificationsWidget" style="position: relative;">
                    <button class="chat-btn" onclick="toggleNotifications()" id="notificationsBtn">ğŸ”” ×”×ª×¨××•×ª <span id="notificationBadge" style="display: none; background: #f44336; color: white; border-radius: 50%; padding: 0.2rem 0.5rem; font-size: 0.8em; margin-right: 0.5rem;">0</span></button>
                    <div id="notificationsDropdown" class="notifications-dropdown" style="display: none;">
                        <div class="notifications-header">
                            <span>×”×ª×¨××•×ª</span>
                            <button class="btn-clear-notifications" onclick="clearNotifications()" title="× ×§×” ×”×ª×¨××•×ª × ×§×¨××•×ª">ğŸ§¹ × ×§×” × ×§×¨××•×ª</button>
                        </div>
                        <div id="notificationsList" class="notifications-list">
                            <div class="notification-item loading">×˜×•×¢×Ÿ ×”×ª×¨××•×ª...</div>
                        </div>
                    </div>
                </li>
                <li id="authButton">
                    <button class="chat-btn" id="loginBtn" onclick="window.location.href='/login'">ğŸ” ×”×ª×—×‘×¨</button>
                </li>
                <li><button class="chat-btn" onclick="toggleChat()">ğŸ’¬ ×¦'××˜</button></li>
            </ul>
        </div>
    </nav>
    
    <div class="container">
        <section class="section">
            <div class="section-header">
                <div class="section-icon">ğŸ“š</div>
                <div style="flex: 1;">
                    <h2 class="section-title">×”×§×•×¨×¡×™× ×©×œ×™</h2>
                    <p class="section-subtitle">× ×”×œ ××ª ×”×§×•×¨×¡×™× ×©×œ×š ×•×‘×—×¨ ×¡××¡×˜×¨ ×œ×›×œ ×§×•×¨×¡</p>
                </div>
                <div class="current-semester-selector" style="display: flex; align-items: center; gap: 1rem;">
                    <label for="currentSemesterSelect" style="font-weight: 500; color: #333;">×¡××¡×˜×¨ × ×•×›×—×™:</label>
                    <select id="currentSemesterSelect" style="padding: 0.5rem 1rem; border-radius: 8px; border: 2px solid #667eea; font-size: 1rem; background: white; cursor: pointer;">
                        <option value="">-- ×‘×—×¨ ×¡××¡×˜×¨ --</option>
                        <option value="×—×•×¨×£">×—×•×¨×£</option>
                        <option value="××‘×™×‘">××‘×™×‘</option>
                        <option value="×§×™×¥">×§×™×¥</option>
                    </select>
                    <label for="currentYearSelect" style="font-weight: 500; color: #333;">×©× ×”:</label>
                    <select id="currentYearSelect" style="padding: 0.5rem 1rem; border-radius: 8px; border: 2px solid #667eea; font-size: 1rem; background: white; cursor: pointer;">
                        <option value="">-- ×‘×—×¨ ×©× ×” --</option>
                    </select>
                    <button onclick="saveCurrentSemesterAndYear()" style="padding: 0.5rem 1.5rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">
                        ×©××•×¨
                    </button>
                </div>
            </div>
            
            <!-- Course Tabs -->
            <div class="course-tabs-container">
                <div class="course-tabs" id="courseTabs">
                    <!-- Will be populated by JavaScript -->
                </div>
                <div class="course-tab-content" id="courseTabContent">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
        </section>
    </div>
    
    <!-- Invitation Dialog Modal -->
    <div id="invitationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>×”×–×× ×” ×œ×§×‘×•×¦×ª ×œ×™××•×“</h3>
                <button class="close-btn" onclick="closeInvitationModal()">Ã—</button>
            </div>
            <div id="invitationModalBody" style="padding: 1.5rem 0;">
                <p id="invitationMessage"></p>
            </div>
            <div class="modal-actions">
                <button class="btn-primary" onclick="acceptInvitationFromModal()" id="acceptInvitationBtn">âœ… ×§×‘×œ ×”×–×× ×”</button>
                <button class="btn-secondary" onclick="rejectInvitationFromModal()" id="rejectInvitationBtn">âŒ ×“×—×” ×”×–×× ×”</button>
            </div>
        </div>
    </div>
    
    <!-- Create Group Modal -->
    <div id="createGroupModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>×¦×•×¨ ×§×‘×•×¦×ª ×œ×™××•×“</h3>
                <button class="close-btn" onclick="closeCreateGroupModal()">Ã—</button>
            </div>
            <form id="createGroupForm" onsubmit="createGroup(event)">
                <input type="hidden" id="groupCourseId" />
                <input type="hidden" id="groupCourseName" />
                
                <div class="form-group">
                    <label>×©× ×”×§×‘×•×¦×”</label>
                    <input type="text" id="groupName" required placeholder="×œ××©×œ: ×§×‘×•×¦×ª ×œ×™××•×“ - ××‘×•× ×œ××“×¢×™ ×”××—×©×‘" />
                </div>
                
                <div class="form-group">
                    <label>×ª×™××•×¨ (××•×¤×¦×™×•× ×œ×™)</label>
                    <textarea id="groupDescription" rows="3" placeholder="×ª×™××•×¨ ×§×¦×¨ ×©×œ ×”×§×‘×•×¦×”..."></textarea>
                </div>
                
                <div class="form-group">
                    <label>×”×–××Ÿ ×—×‘×¨×™× ×œ×¤×™ ××™×™×œ</label>
                    <div id="inviteEmails" class="invite-emails">
                        <div class="email-input-row">
                            <input type="email" class="email-input" placeholder="email@example.com" />
                            <button type="button" class="btn-remove-email" onclick="removeEmailInput(this)" style="display: none;">Ã—</button>
                        </div>
                    </div>
                    <button type="button" class="btn-add-email" onclick="addEmailInput()">+ ×”×•×¡×£ ××™×™×œ × ×•×¡×£</button>
                </div>
                
                <div class="modal-actions">
                    <button type="submit" class="btn-primary">×¦×•×¨ ×§×‘×•×¦×”</button>
                    <button type="button" class="btn-secondary" onclick="closeCreateGroupModal()">×‘×™×˜×•×œ</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Add Assignment Modal -->
    <div id="addAssignmentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>×”×•×¡×£ ××˜×œ×” ×—×“×©×”</h3>
                <button class="close-btn" onclick="closeAddAssignmentModal()">Ã—</button>
            </div>
            <form id="addAssignmentForm" onsubmit="createAssignment(event)">
                <input type="hidden" id="assignmentCourseNumber" />
                <input type="hidden" id="assignmentCourseName" />
                
                <div class="form-group">
                    <label>×§×•×¨×¡</label>
                    <input type="text" id="assignmentCourseDisplay" readonly style="background: #f5f5f5;" />
                </div>
                
                <div class="form-group">
                    <label>×›×•×ª×¨×ª ×”××˜×œ×” *</label>
                    <input type="text" id="assignmentTitle" required placeholder="×œ××©×œ: ×ª×¨×’×™×œ 1 - ××©×ª× ×™× ×•×§×œ×˜" />
                </div>
                
                <div class="form-group">
                    <label>×ª×™××•×¨ (××•×¤×¦×™×•× ×œ×™)</label>
                    <textarea id="assignmentDescription" rows="3" placeholder="×ª×™××•×¨ ×”××˜×œ×”, ×”×•×¨××•×ª ×”×’×©×” ×•×›×•'..."></textarea>
                </div>
                
                <div class="form-group">
                    <label>×ª××¨×™×š ×”×’×©×” *</label>
                    <input type="date" id="assignmentDueDate" required />
                </div>
                
                <div class="form-group">
                    <label>×¢×“×™×¤×•×ª</label>
                    <select id="assignmentPriority">
                        <option value="low">× ××•×›×”</option>
                        <option value="medium" selected>×‘×™× ×•× ×™×ª</option>
                        <option value="high">×’×‘×•×”×”</option>
                    </select>
                </div>
                
                <div class="modal-actions">
                    <button type="submit" class="btn-primary">×”×•×¡×£ ××˜×œ×”</button>
                    <button type="button" class="btn-secondary" onclick="closeAddAssignmentModal()">×‘×™×˜×•×œ</button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        // Debug logging
        console.log('ğŸ” [DEBUG] my_courses.html script started');
        console.log('ğŸ” [DEBUG] document.readyState:', document.readyState);
        
        // Check authentication - simple check like in schedule.html
        const token = localStorage.getItem('auth_token');
        console.log('ğŸ” [DEBUG] Token from localStorage:', token ? `Found (length: ${token.length})` : 'NOT FOUND');
        
        const loginBtn = document.getElementById('loginBtn');
        console.log('ğŸ” [DEBUG] loginBtn element:', loginBtn ? 'Found' : 'NOT FOUND');
        
        if (!token) {
            console.log('ğŸ” [DEBUG] No token - showing login button');
            if (loginBtn) {
                loginBtn.style.display = 'block';
            }
        } else {
            console.log('ğŸ” [DEBUG] Token found - updating button');
            const userEmail = localStorage.getItem('user_email') || '××©×ª××©';
            console.log('ğŸ” [DEBUG] User email:', userEmail);
            if (loginBtn) {
                loginBtn.textContent = `ğŸ‘¤ ${userEmail}`;
                loginBtn.onclick = () => {
                    if (confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×”×ª× ×ª×§?')) {
                        console.log('ğŸ” [DEBUG] User clicked logout - removing token');
                localStorage.removeItem('auth_token');
                localStorage.removeItem('user_id');
                localStorage.removeItem('user_email');
                window.location.href = '/login';
                    }
            };
                console.log('ğŸ” [DEBUG] Button updated successfully');
            } else {
                console.error('ğŸ” [DEBUG] ERROR: loginBtn not found!');
            }
        }
        
        // Days array
        const days = ['×¨××©×•×Ÿ', '×©× ×™', '×©×œ×™×©×™', '×¨×‘×™×¢×™', '×—××™×©×™', '×©×™×©×™', '×©×‘×ª'];
        
        // Courses array - will be loaded from user's courses table (filtered by current semester)
        let courses = [];
        
        // Store groups data
        let userGroups = {};
        let notifications = [];
        let assignmentsData = {};  // Store assignments for each course
        
        // Notifications functions
        async function loadNotifications() {
            const token = localStorage.getItem('auth_token');
            if (!token) return;
            
            try {
                const response = await fetch('/api/notifications', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    notifications = data.notifications || [];
                    updateNotificationsUI();
                } else if (response.status === 401) {
                    // Token expired or invalid - don't redirect automatically, just skip
                    console.log('Not authenticated - skipping notifications');
                    return;
                }
            } catch (error) {
                console.error('Error loading notifications:', error);
            }
        }
        
        function updateNotificationsUI() {
            const badge = document.getElementById('notificationBadge');
            const unreadCount = notifications.filter(n => !n.read).length;
            
            if (badge) {
                if (unreadCount > 0) {
                    badge.textContent = unreadCount;
                    badge.style.display = 'inline-block';
                } else {
                    badge.style.display = 'none';
                }
            }
            
            const list = document.getElementById('notificationsList');
            if (list) {
                if (notifications.length === 0) {
                    list.innerHTML = '<div class="notification-item loading">××™×Ÿ ×”×ª×¨××•×ª</div>';
                } else {
                    list.innerHTML = notifications.map(notif => {
                        const time = new Date(notif.created_at).toLocaleString('he-IL');
                        return `
                            <div class="notification-item ${!notif.read ? 'unread' : ''}" style="display: flex; justify-content: space-between; align-items: start; gap: 0.5rem;">
                                <div onclick="handleNotificationClick('${notif.id}', '${notif.type}', '${notif.link || ''}')" style="flex: 1; cursor: pointer;">
                                    <div class="notification-title">${notif.title}</div>
                                    <div class="notification-message">${notif.message}</div>
                                    <div class="notification-time">${time}</div>
                                </div>
                                <button onclick="event.stopPropagation(); if(confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ×”×ª×¨××” ×–×•?')) deleteNotification('${notif.id}')" style="background: #f44336; color: white; border: none; padding: 0.3rem 0.6rem; border-radius: 4px; cursor: pointer; font-size: 0.8em; flex-shrink: 0;" title="××—×§ ×”×ª×¨××”">Ã—</button>
                            </div>
                        `;
                    }).join('');
                }
            }
        }
        
        function toggleNotifications() {
            const dropdown = document.getElementById('notificationsDropdown');
            if (dropdown) {
                if (dropdown.style.display === 'none') {
                    dropdown.style.display = 'block';
                    loadNotifications();
                } else {
                    dropdown.style.display = 'none';
                }
            }
        }
        
        async function handleNotificationClick(notificationId, type, link) {
            const token = localStorage.getItem('auth_token');
            if (!token) return;
            
            // Handle based on type FIRST (before marking as read)
            // This way if there's an error, the notification stays visible
            if (type === 'group_invitation') {
                // Try to get invitation_id by notification_id (most reliable)
                let invitationId = null;
                
                try {
                    const invResponse = await fetch(`/api/groups/invitations/by-notification/${notificationId}`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    if (invResponse.ok) {
                        const invData = await invResponse.json();
                        invitationId = invData.invitation_id;
                    } else {
                        console.error('Failed to get invitation by notification:', await invResponse.text());
                    }
                } catch (error) {
                    console.error('Error getting invitation by notification:', error);
                }
                
                // Fallback: try to extract from link
                if (!invitationId && link) {
                    const invitationMatch = link.match(/invitation=([^&]+)/);
                    if (invitationMatch) {
                        invitationId = invitationMatch[1];
                    } else {
                        // If no invitation_id in link, try to get it by group_id
                        const groupMatch = link.match(/group=([^&]+)/);
                        if (groupMatch) {
                            const groupId = groupMatch[1];
                            try {
                                const invResponse = await fetch(`/api/groups/invitations/by-group/${groupId}`, {
                                    headers: {
                                        'Authorization': `Bearer ${token}`
                                    }
                                });
                                if (invResponse.ok) {
                                    const invData = await invResponse.json();
                                    invitationId = invData.invitation_id;
                                } else {
                                    console.error('Failed to get invitation by group:', await invResponse.text());
                                }
                            } catch (error) {
                                console.error('Error getting invitation by group:', error);
                            }
                        }
                    }
                }
                
                if (invitationId) {
                    showInvitationDialog(invitationId);
                } else {
                    alert('×œ× × ××¦××” ×”×–×× ×”. ×× × × ×¡×” ×©×•×‘.');
                }
            } else if (link) {
                window.location.href = link;
            }
            
            // Mark as read when clicked (but don't delete - user can delete manually)
            // This updates the unread count badge
            try {
                await fetch(`/api/notifications/${notificationId}/read`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                // Reload notifications to update the badge count
                await loadNotifications();
            } catch (error) {
                console.error('Error marking notification as read:', error);
            }
        }
        
        let currentInvitationId = null;
        
        async function showInvitationDialog(invitationId) {
            currentInvitationId = invitationId;
            
            // Get invitation details
            const token = localStorage.getItem('auth_token');
            if (!token) return;
            
            try {
                // Get notification details to show message
                const notifResponse = await fetch('/api/notifications', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (notifResponse.ok) {
                    const notifData = await notifResponse.json();
                    const notification = notifData.notifications.find(n => {
                        if (n.link) {
                            const match = n.link.match(/invitation=([^&]+)/);
                            return match && match[1] === invitationId;
                        }
                        return false;
                    });
                    
                    if (notification) {
                        document.getElementById('invitationMessage').textContent = notification.message;
                    } else {
                        document.getElementById('invitationMessage').textContent = '×”×ª×§×‘×œ×” ×”×–×× ×” ×œ×”×¦×˜×¨×£ ×œ×§×‘×•×¦×ª ×œ×™××•×“';
                    }
                }
            } catch (error) {
                console.error('Error loading invitation details:', error);
                document.getElementById('invitationMessage').textContent = '×”×ª×§×‘×œ×” ×”×–×× ×” ×œ×”×¦×˜×¨×£ ×œ×§×‘×•×¦×ª ×œ×™××•×“';
            }
            
            // Show modal
            const modal = document.getElementById('invitationModal');
            if (modal) {
                modal.classList.add('active');
            }
        }
        
        function closeInvitationModal() {
            const modal = document.getElementById('invitationModal');
            if (modal) {
                modal.classList.remove('active');
            }
            currentInvitationId = null;
        }
        
        async function acceptInvitationFromModal() {
            if (currentInvitationId) {
                // Save the ID before closing the modal (which sets it to null)
                const invitationId = currentInvitationId;
                closeInvitationModal();
                await acceptInvitation(invitationId);
            } else {
                console.error('No invitation ID available');
                alert('×©×’×™××”: ×œ× × ××¦× ××–×”×” ×”×–×× ×”');
            }
        }
        
        async function rejectInvitationFromModal() {
            if (currentInvitationId) {
                // Save the ID before closing the modal (which sets it to null)
                const invitationId = currentInvitationId;
                closeInvitationModal();
                await rejectInvitation(invitationId);
            } else {
                console.error('No invitation ID available');
            }
        }
        
        async function acceptInvitation(invitationId) {
            const token = localStorage.getItem('auth_token');
            if (!token) return;
            
            try {
                const response = await fetch(`/api/groups/invitations/${invitationId}/accept`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    alert('âœ… ×”×¦×˜×¨×¤×ª ×‘×”×¦×œ×—×” ×œ×§×‘×•×¦×”!');
                    // Reload everything - notification will be marked as read by backend
                    await loadNotifications();
                    await loadUserGroups();
                    await displayMyCourses();
                } else {
                    const error = await response.json();
                    const errorMsg = error.detail || '×œ× × ×™×ª×Ÿ ×œ×”×¦×˜×¨×£ ×œ×§×‘×•×¦×”';
                    alert('×©×’×™××”: ' + errorMsg);
                    console.error('Error accepting invitation:', error);
                    // Reload notifications to make sure it's still visible
                    await loadNotifications();
                }
            } catch (error) {
                console.error('Error accepting invitation:', error);
                alert('×©×’×™××” ×‘×”×¦×˜×¨×¤×•×ª ×œ×§×‘×•×¦×”');
            }
        }
        
        async function rejectInvitation(invitationId) {
            const token = localStorage.getItem('auth_token');
            if (!token) return;
            
            try {
                const response = await fetch(`/api/groups/invitations/${invitationId}/reject`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    alert('×”×–×× ×” × ×“×—×ª×”');
                    await loadNotifications();
                }
            } catch (error) {
                console.error('Error rejecting invitation:', error);
            }
        }
        
        // Delete single notification
        async function deleteNotification(notificationId) {
            const token = localStorage.getItem('auth_token');
            if (!token) return;
            
            try {
                const response = await fetch(`/api/notifications/${notificationId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    await loadNotifications();
                } else {
                    const error = await response.json();
                    alert('×©×’×™××”: ' + (error.detail || '×œ× × ×™×ª×Ÿ ×œ××—×•×§ ×”×ª×¨××”'));
                }
            } catch (error) {
                console.error('Error deleting notification:', error);
                alert('×©×’×™××” ×‘××—×™×§×ª ×”×ª×¨××”');
            }
        }
        
        // Clear notifications
        async function clearNotifications() {
            if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×›×œ ×”×”×ª×¨××•×ª ×”× ×§×¨××•×ª?')) {
                return;
            }
            
            const token = localStorage.getItem('auth_token');
            if (!token) {
                alert('×× × ×”×ª×—×‘×¨ ×›×“×™ ×œ× ×§×•×ª ×”×ª×¨××•×ª');
                return;
            }
            
            try {
                const response = await fetch('/api/notifications?read_only=true', {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    alert('âœ… ×”×”×ª×¨××•×ª ×”× ×§×¨××•×ª × ××—×§×•');
                    await loadNotifications();
                } else {
                    const error = await response.json();
                    alert('×©×’×™××”: ' + (error.detail || '×œ× × ×™×ª×Ÿ ×œ××—×•×§ ×”×ª×¨××•×ª'));
                }
            } catch (error) {
                console.error('Error clearing notifications:', error);
                alert('×©×’×™××” ×‘××—×™×§×ª ×”×ª×¨××•×ª');
            }
        }
        
        // Delete group
        async function deleteGroup(groupId, groupName) {
            if (!confirm(`×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”×§×‘×•×¦×” "${groupName}"?\n\n×¤×¢×•×œ×” ×–×• ×œ× × ×™×ª× ×ª ×œ×‘×™×˜×•×œ!`)) {
                return;
            }
            
            const token = localStorage.getItem('auth_token');
            if (!token) {
                alert('×× × ×”×ª×—×‘×¨ ×›×“×™ ×œ××—×•×§ ×§×‘×•×¦×”');
                return;
            }
            
            try {
                const response = await fetch(`/api/groups/${groupId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    alert('âœ… ×”×§×‘×•×¦×” × ××—×§×” ×‘×”×¦×œ×—×”!');
                    await loadUserGroups();
                    await displayMyCourses();
                } else {
                    const error = await response.json();
                    alert('×©×’×™××”: ' + (error.detail || '×œ× × ×™×ª×Ÿ ×œ××—×•×§ ××ª ×”×§×‘×•×¦×”'));
                }
            } catch (error) {
                console.error('Error deleting group:', error);
                alert('×©×’×™××” ×‘××—×™×§×ª ×”×§×‘×•×¦×”');
            }
        }
        
        // Display My Courses with Tabs
        async function displayMyCourses() {
            console.log('ğŸ” [DEBUG] ========== displayMyCourses() called ==========');
            console.log('ğŸ” [DEBUG] courses.length:', courses.length);
            console.log('ğŸ” [DEBUG] courses array:', courses);
            
            const courseTabs = document.getElementById('courseTabs');
            const courseTabContent = document.getElementById('courseTabContent');
            
            console.log('ğŸ” [DEBUG] courseTabs:', courseTabs ? 'Found' : 'NOT FOUND');
            console.log('ğŸ” [DEBUG] courseTabContent:', courseTabContent ? 'Found' : 'NOT FOUND');
            
            if (!courseTabs || !courseTabContent) {
                console.error('ğŸ” [DEBUG] ERROR: Missing DOM elements!');
                return;
            }
            
            if (courses.length === 0) {
                console.warn('ğŸ” [DEBUG] WARNING: courses array is empty!');
                const token = localStorage.getItem('auth_token');
                let message = '';
                if (token) {
                    // User is logged in but no courses to show
                    message = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“š</div>
                            <p>××™×Ÿ ×§×•×¨×¡×™× ×œ×”×¦×’×”</p>
                            <p style="font-size: 0.9em; color: #999; margin-top: 0.5rem;">
                                ×‘×—×¨ ×¡××¡×˜×¨ × ×•×›×—×™ ×œ××¢×œ×” ×›×“×™ ×œ×¨××•×ª ××ª ×”×§×•×¨×¡×™× ×©×œ ×”×¡××¡×˜×¨ ×”× ×‘×—×¨
                            </p>
                            <p style="font-size: 0.9em; color: #999; margin-top: 0.5rem;">
                                ××• ×”×•×¡×£ ×§×•×¨×¡×™× ×œ×˜×‘×œ×ª courses ×‘-Supabase
                            </p>
                        </div>
                    `;
                } else {
                    message = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“š</div>
                        <p>×”×§×•×¨×¡×™× ×©×œ×š ×™×•×¤×™×¢×• ×›××Ÿ</p>
                            <p style="font-size: 0.9em; color: #999; margin-top: 0.5rem;">×× × ×”×ª×—×‘×¨ ×›×“×™ ×œ×¨××•×ª ××ª ×”×§×•×¨×¡×™× ×©×œ×š</p>
                    </div>
                `;
                }
                courseTabContent.innerHTML = message;
                return;
            }
            
            // Load user groups
            await loadUserGroups();
            
            // Create tabs
            console.log('ğŸ” [DEBUG] Creating tabs for', courses.length, 'courses');
            const tabsHTML = courses.map((course, index) => {
                const courseId = course.course_number || course.id || index;
                const courseName = course.course_name || course.name || '×§×•×¨×¡ ×œ×œ× ×©×';
                
                // Check if course has groups (ONLY by course_number)
                // Use the same logic as courseGroups matching
                let hasGroup = false;
                if (userGroups && Object.keys(userGroups).length > 0 && course.course_number) {
                    const courseNum = course.course_number;
                    const courseNumStr = String(courseNum).trim();
                    
                    // Check all groups to see if any match this course_number
                    for (const key in userGroups) {
                        const groups = userGroups[key];
                        if (Array.isArray(groups) && groups.length > 0) {
                            const hasMatchingGroup = groups.some(group => {
                                const groupCourseId = group.course_id;
                                const groupCourseIdStr = String(groupCourseId).trim();
                                
                                return (
                                    groupCourseId === courseNum ||
                                    groupCourseId === courseNumStr ||
                                    groupCourseIdStr === courseNumStr ||
                                    groupCourseIdStr === String(courseNum).trim()
                                );
                            });
                            
                            if (hasMatchingGroup) {
                                hasGroup = true;
                                break;
                            }
                        }
                    }
                }
                
                console.log(`ğŸ” [DEBUG] Creating tab ${index}: ${courseName}, course_number: ${course.course_number}, hasGroup: ${hasGroup}`);
                return `
                    <div class="course-tab ${index === 0 ? 'active' : ''}" onclick="switchCourseTab(${index})" data-course-index="${index}">
                        ${courseName} ${hasGroup ? 'ğŸ‘¥' : ''}
                    </div>
                `;
            }).join('');
            courseTabs.innerHTML = tabsHTML;
            console.log('ğŸ” [DEBUG] Tabs HTML created, length:', tabsHTML.length);
            
            // Create tab content
            console.log('ğŸ” [DEBUG] Creating tab content for', courses.length, 'courses');
            const contentHTML = courses.map((course, index) => {
                console.log(`ğŸ” [DEBUG] Creating content for course ${index}:`, course);
                // Use course_number as primary identifier for groups (not course.id UUID)
                const courseId = course.course_number || course.id || index;
                const courseName = course.course_name || course.name || '×§×•×¨×¡ ×œ×œ× ×©×';
                
                // Match groups by course_number ONLY
                // Groups are already filtered by user membership in /api/groups/my-groups
                let courseGroups = [];
                if (userGroups && Object.keys(userGroups).length > 0 && course.course_number) {
                    const courseNum = course.course_number;
                    const courseNumStr = String(courseNum).trim();
                    
                    // Try to find groups by course_number (handle type mismatches)
                    // Check all possible keys in userGroups
                    for (const key in userGroups) {
                        const groups = userGroups[key];
                        if (Array.isArray(groups) && groups.length > 0) {
                            // Check if any group in this array matches the course_number
                            const matchingGroups = groups.filter(group => {
                                const groupCourseId = group.course_id;
                                const groupCourseIdStr = String(groupCourseId).trim();
                                
                                // Match by exact value or string comparison
                                return (
                                    groupCourseId === courseNum ||
                                    groupCourseId === courseNumStr ||
                                    groupCourseIdStr === courseNumStr ||
                                    groupCourseIdStr === String(courseNum).trim()
                                );
                            });
                            
                            if (matchingGroups.length > 0) {
                                courseGroups = matchingGroups;
                                console.log(`âœ… [GROUPS] Found ${courseGroups.length} groups for course "${courseName}" (course_number: ${courseNum})`);
                                break;
                            }
                        }
                    }
                    
                    if (courseGroups.length === 0) {
                        console.log(`âŒ [GROUPS] No groups found for course "${courseName}" (course_number: ${courseNum})`);
                        console.log(`   Available group keys:`, Object.keys(userGroups));
                        console.log(`   Groups by key:`, Object.keys(userGroups).map(key => ({
                            key: key,
                            groups: userGroups[key].map(g => ({ name: g.group_name, course_id: g.course_id }))
                        })));
                    }
                } else {
                    if (!course.course_number) {
                        console.log(`âš ï¸ [GROUPS] Course "${courseName}" has no course_number`);
                    }
                    if (!userGroups || Object.keys(userGroups).length === 0) {
                        console.log(`âš ï¸ [GROUPS] No userGroups available`);
                    }
                }
                // Match assignments by course_number ONLY
                let courseAssignments = [];
                
                // Make sure assignmentsData exists and has data
                if (assignmentsData && typeof assignmentsData === 'object' && Object.keys(assignmentsData).length > 0) {
                    const courseNumber = course.course_number;
                    const courseNumberStr = String(courseNumber).trim();
                    
                    console.log('ğŸ” [ASSIGNMENTS MATCH] Looking for assignments for course:', {
                        courseName: course.course_name,
                        courseNumber: courseNumber,
                        courseNumberStr: courseNumberStr,
                        availableKeys: Object.keys(assignmentsData)
                    });
                    
                    // Match assignments by course_number
                    // The API groups assignments by course_number (from course_catalog)
                    // We need to match course.course_number with assignment.course_catalog.course_number
                    if (courseNumber) {
                        const courseNumberStr = String(courseNumber).trim();
                        
                        // First try direct key lookup (assignments are keyed by course_number from API)
                        if (assignmentsData[courseNumber]) {
                            courseAssignments = assignmentsData[courseNumber];
                            console.log(`âœ… [ASSIGNMENTS MATCH] Found by direct key (courseNumber): ${courseNumber}`);
                        } else if (assignmentsData[courseNumberStr]) {
                            courseAssignments = assignmentsData[courseNumberStr];
                            console.log(`âœ… [ASSIGNMENTS MATCH] Found by direct key (courseNumberStr): ${courseNumberStr}`);
                        } else {
                            // If direct lookup fails, iterate through all assignments and match by course_number
                            console.log(`ğŸ” [ASSIGNMENTS MATCH] Direct lookup failed for course_number "${courseNumber}", trying iteration through all assignments...`);
                            console.log(`   Available keys in assignmentsData:`, Object.keys(assignmentsData));
                            
                            for (const key in assignmentsData) {
                                const assignments = assignmentsData[key];
                                if (Array.isArray(assignments) && assignments.length > 0) {
                                    // Check if any assignment in this array matches the course_number
                                    const matchingAssignments = assignments.filter(assignment => {
                                        // Prefer course_number directly from assignment, then from course_info/course_catalog
                                        const assignmentCourseNumberDirect = assignment.course_number; // Direct field in assignment
                                        const assignmentCourseInfo = assignment.course_info || assignment.course_catalog || {};
                                        const assignmentCourseNumberFromCatalog = assignmentCourseInfo.course_number;
                                        
                                        // Use direct course_number first, then fallback to course_catalog
                                        const assignmentCourseNumber = assignmentCourseNumberDirect || assignmentCourseNumberFromCatalog;
                                        
                                        if (!assignmentCourseNumber) {
                                            console.log(`   âš ï¸ Assignment "${assignment.title}" has no course_number (direct: ${assignmentCourseNumberDirect}, from_catalog: ${assignmentCourseNumberFromCatalog})`);
                                            return false;
                                        }
                                        
                                        const assignmentCourseNumberStr = String(assignmentCourseNumber).trim();
                                        
                                        // Match by course_number (try all type combinations)
                                        const matches = (
                                            assignmentCourseNumber === courseNumber ||
                                            assignmentCourseNumber === courseNumberStr ||
                                            assignmentCourseNumberStr === courseNumberStr ||
                                            assignmentCourseNumberStr === String(courseNumber).trim()
                                        );
                                        
                                        if (matches) {
                                            console.log(`   âœ… Match found: assignment "${assignment.title}" has course_number "${assignmentCourseNumber}" (direct: ${assignmentCourseNumberDirect || 'none'}, from_catalog: ${assignmentCourseNumberFromCatalog || 'none'}) matching course "${course.course_name}" with course_number "${courseNumber}"`);
                                        }
                                        
                                        return matches;
                                    });
                                    
                                    if (matchingAssignments.length > 0) {
                                        courseAssignments = matchingAssignments;
                                        console.log(`âœ… [ASSIGNMENTS MATCH] Found ${courseAssignments.length} assignments for course "${course.course_name}" (course_number: ${courseNumber}) by iteration, key: ${key}`);
                                        break;
                                    }
                                }
                            }
                        }
                    } else {
                        console.log(`âš ï¸ [ASSIGNMENTS MATCH] Course "${course.course_name}" has no course_number!`);
                    }
                    
                    if (courseAssignments.length === 0) {
                        console.log(`âŒ [ASSIGNMENTS MATCH] No assignments found for course "${course.course_name}" (course_number: ${courseNumber})`);
                        console.log(`   Available assignment keys:`, Object.keys(assignmentsData));
                        console.log(`   Assignments by key:`, Object.keys(assignmentsData).map(key => {
                            const assignments = assignmentsData[key];
                            if (Array.isArray(assignments) && assignments.length > 0) {
                                const first = assignments[0];
                                const courseInfo = first.course_info || first.course_catalog || {};
                                return {
                                    key: key,
                                    course_number: courseInfo.course_number,
                                    course_name: courseInfo.course_name,
                                    count: assignments.length
                                };
                            }
                            return { key: key, count: 0 };
                        }));
                    }
                } else {
                    console.log('âš ï¸ [ASSIGNMENTS MATCH] assignmentsData is empty or invalid');
                }
                
                // Render assignments HTML - always show section
                let assignmentsHTML = `
                        <div class="assignments-section">
                            <div class="assignments-header">
                            <h3>ğŸ“ ××˜×œ×•×ª ×œ×”×’×©×” ${courseAssignments && courseAssignments.length > 0 ? `(${courseAssignments.length})` : '(0)'}</h3>
                            <button class="add-assignment-btn" onclick="openAddAssignmentModal('${course.course_number || course.id}', '${courseName}')" title="×”×•×¡×£ ××˜×œ×” ×—×“×©×”">
                                â• ×”×•×¡×£ ××˜×œ×”
                            </button>
                            </div>
                            <div>
                            ${courseAssignments && courseAssignments.length > 0 ? courseAssignments.map(assignment => {
                                const daysRemaining = assignment.days_remaining !== undefined ? assignment.days_remaining : 0;
                                    const isOverdue = daysRemaining < 0;
                                    const isUrgent = daysRemaining <= 3 && daysRemaining >= 0;
                                const priorityClass = `${assignment.priority || 'medium'}-priority`;
                                    const completedClass = assignment.is_completed ? 'completed' : '';
                                
                                // Format due date for display
                                let dueDateDisplay = assignment.due_date || '×œ× ×¦×•×™×Ÿ';
                                if (assignment.due_date) {
                                    try {
                                        const date = new Date(assignment.due_date);
                                        dueDateDisplay = date.toLocaleDateString('he-IL', { 
                                            year: 'numeric', 
                                            month: 'long', 
                                            day: 'numeric' 
                                        });
                                    } catch (e) {
                                        dueDateDisplay = assignment.due_date;
                                    }
                                }
                                    
                                    let daysClass = 'days-plenty';
                                let daysText = '';
                                    
                                    if (isOverdue) {
                                        daysClass = 'days-overdue';
                                        daysText = 'âš ï¸ ' + Math.abs(daysRemaining) + ' ×™××™× ×¢×‘×¨×•';
                                    } else if (daysRemaining === 0) {
                                        daysClass = 'days-urgent';
                                    daysText = 'â° ×”×™×•×!';
                                    } else if (daysRemaining === 1) {
                                        daysClass = 'days-urgent';
                                    daysText = 'â° ××—×¨!';
                                } else if (daysRemaining === 2) {
                                    daysClass = 'days-urgent';
                                    daysText = 'â° ×¢×•×“ 2 ×™××™×';
                                    } else if (isUrgent) {
                                        daysClass = 'days-soon';
                                    daysText = 'â° ×¢×•×“ ' + daysRemaining + ' ×™××™×';
                                } else {
                                    daysText = 'â° ×¢×•×“ ' + daysRemaining + ' ×™××™×';
                                    }
                                    
                                    return '<div class="assignment-card ' + priorityClass + ' ' + completedClass + '">' +
                                        '<div class="assignment-info">' +
                                    '<div class="assignment-title">' + (assignment.title || '××˜×œ×” ×œ×œ× ×›×•×ª×¨×ª') + '</div>' +
                                    (assignment.description ? '<div class="assignment-description">' + assignment.description + '</div>' : '') +
                                        '<div class="assignment-meta">' +
                                    '<span class="assignment-due-date">ğŸ“… ×ª××¨×™×š ×”×’×©×”: ' + dueDateDisplay + '</span>' +
                                        '<span class="days-remaining ' + daysClass + '">' + daysText + '</span>' +
                                        '</div>' +
                                        '</div>' +
                                        '<div class="assignment-status">' +
                                        '<input type="checkbox" class="assignment-checkbox" ' + (assignment.is_completed ? 'checked' : '') + ' onchange="updateAssignmentStatus(\'' + assignment.id + '\', this.checked)" title="×¡××Ÿ ×›×”×•×©×œ×">' +
                                        '</div>' +
                                        '</div>';
                            }).join('') : '<div class="empty-assignments">××™×Ÿ ××˜×œ×•×ª ×œ×”×’×©×” ×¢×‘×•×¨ ×§×•×¨×¡ ×–×”</div>'}
                            </div>
                        </div>
                    `;
                
                return `
                    <div class="course-tab-panel ${index === 0 ? 'active' : ''}" data-course-index="${index}">
                        <div class="my-course-header">
                            <div>
                                <div class="my-course-title">
                                    ${courseName}
                                    ${course.course_number ? `<span class="my-course-number">(${course.course_number})</span>` : ''}
                                </div>
                            </div>
                        </div>
                        <div class="my-course-content">
                            ${course.credit_points ? `
                                <div class="my-course-field">
                                    <span class="my-course-field-label">× ×§×•×“×•×ª ×–×›×•×ª</span>
                                    <span class="my-course-field-value">${course.credit_points}</span>
                                </div>
                            ` : ''}
                            ${course.semester ? `
                                <div class="my-course-field">
                                    <span class="my-course-field-label">×¡××¡×˜×¨</span>
                                    <span class="my-course-field-value">${course.semester}</span>
                                </div>
                            ` : ''}
                        </div>
                        <div class="semester-selector">
                            <label>×‘×—×¨ ×¡××¡×˜×¨:</label>
                            <select id="semester-${index}" onchange="updateCourseSemester(${index}, this.value)">
                                <option value="">×œ× × ×‘×—×¨</option>
                                <option value="×—×•×¨×£" ${course.semester === '×—×•×¨×£' ? 'selected' : ''}>×—×•×¨×£</option>
                                <option value="×§×™×¥" ${course.semester === '×§×™×¥' ? 'selected' : ''}>×§×™×¥</option>
                                <option value="××‘×™×‘" ${course.semester === '××‘×™×‘' ? 'selected' : ''}>××‘×™×‘</option>
                            </select>
                        </div>
                        
                        <!-- Assignments Section -->
                        ${assignmentsHTML}
                        
                        <!-- Groups Section -->
                        <div style="margin-top: 2rem; padding-top: 2rem; border-top: 2px solid #f0f0f0;">
                            <h3 style="margin-bottom: 1rem; color: #333;">×§×‘×•×¦×•×ª ×œ×™××•×“</h3>
                            ${courseGroups.length > 0 ? `
                                <div class="groups-list">
                                    ${courseGroups.map(group => {
                                        // Groups are already matched by course_number in courseGroups
                                        // No need to verify again - just render them
                                        return `
                                        <div class="group-card">
                                            <div onclick="viewGroup('${group.id}')" style="flex: 1; cursor: pointer;">
                                                <div class="group-name">${group.group_name}</div>
                                                <div class="group-meta">
                                                    <span>ğŸ‘¥ ${group.members_count || 0} ×—×‘×¨×™×</span>
                                                    ${group.description ? `<span>ğŸ“ ${group.description}</span>` : ''}
                                                </div>
                                                ${group.members && group.members.length > 0 ? `
                                                    <div class="group-members" style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #e0e0e0;">
                                                        <div style="font-size: 0.85em; color: #666; margin-bottom: 0.3rem;">×—×‘×¨×™× ×‘×§×‘×•×¦×”:</div>
                                                        <div style="display: flex; flex-wrap: wrap; gap: 0.3rem;">
                                                            ${group.members.map(m => `<span style="background: #f0f0f0; padding: 0.2rem 0.5rem; border-radius: 12px; font-size: 0.8em;">${m.email || 'Unknown'}</span>`).join('')}
                                                        </div>
                                                    </div>
                                                ` : ''}
                                            </div>
                                            <button class="btn-delete-group" onclick="event.stopPropagation(); deleteGroup('${group.id}', '${group.group_name}')" title="××—×§ ×§×‘×•×¦×”" style="background: #f44336; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.9em; margin-right: 0.5rem;">
                                                ğŸ—‘ï¸ ××—×§
                                            </button>
                                        </div>
                                    `;
                                    }).join('')}
                                </div>
                            ` : `
                                <p style="color: #666; margin-bottom: 1rem;">××™×Ÿ ×§×‘×•×¦×•×ª ×œ×™××•×“ ×¢×‘×•×¨ ×§×•×¨×¡ ×–×”</p>
                            `}
                            <button class="btn-create-group" onclick="openCreateGroupModal('${course.course_number || course.id || courseId}', '${courseName}')" style="background: #667eea; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 1rem;">
                                ğŸ‘¥ ×¦×•×¨ ×§×‘×•×¦×ª ×œ×™××•×“ ×—×“×©×”
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            courseTabContent.innerHTML = contentHTML;
            console.log('ğŸ” [DEBUG] Content HTML created, length:', contentHTML.length);
            console.log('ğŸ” [DEBUG] First 500 chars of content:', contentHTML.substring(0, 500));
        }
        
        // Switch course tab
        function switchCourseTab(index) {
            // Update tabs
            document.querySelectorAll('.course-tab').forEach((tab, i) => {
                if (i === index) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            
            // Update panels
            document.querySelectorAll('.course-tab-panel').forEach((panel, i) => {
                if (i === index) {
                    panel.classList.add('active');
                } else {
                    panel.classList.remove('active');
                }
            });
            
            // Keep notifications widget visible and updated when switching tabs
            // Reload notifications to ensure they stay visible
            if (localStorage.getItem('auth_token')) {
                loadNotifications();
            }
        }
        
        // Load user groups
        async function loadUserGroups() {
            console.log('ğŸ‘¥ [FRONTEND] loadUserGroups() called');
            const token = localStorage.getItem('auth_token');
            if (!token) {
                console.log('ğŸ‘¥ [FRONTEND] No token, skipping groups');
                return;
            }
            
            try {
                console.log('ğŸ‘¥ [FRONTEND] Fetching /api/groups/my-groups');
                const response = await fetch('/api/groups/my-groups', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                console.log('ğŸ‘¥ [FRONTEND] Response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('ğŸ‘¥ [GROUPS] Loaded groups from API:', data.groups?.length || 0);
                    console.log('ğŸ‘¥ [GROUPS] All groups:', data.groups);
                    
                    // Group groups by course_id (ONLY by course_id, not by course_name to avoid false matches)
                    // course_id should be course_number
                    userGroups = {};
                    (data.groups || []).forEach(group => {
                        const courseId = group.course_id;
                        console.log(`ğŸ‘¥ [GROUPS] Processing group "${group.group_name}"`);
                        console.log(`ğŸ‘¥ [GROUPS]   - course_id: "${courseId}" (type: ${typeof courseId})`);
                        console.log(`ğŸ‘¥ [GROUPS]   - course_name: "${group.course_name}"`);
                        
                        // Index ONLY by course_id (this should be course_number)
                        // Don't index by course_name to avoid false matches
                        // Index by both original and string version to handle type mismatches
                        if (!userGroups[courseId]) {
                            userGroups[courseId] = [];
                        }
                        userGroups[courseId].push(group);
                        
                        // Also index by string version of course_id (in case of type mismatch)
                        const courseIdStr = String(courseId);
                        if (courseIdStr !== courseId) {
                            if (!userGroups[courseIdStr]) {
                                userGroups[courseIdStr] = [];
                            }
                            // Only add if not already in the array (avoid duplicates)
                            if (!userGroups[courseIdStr].some(g => g.id === group.id)) {
                                userGroups[courseIdStr].push(group);
                            }
                        }
                        
                        // Also index by number version if course_id is a numeric string
                        if (typeof courseId === 'string' && !isNaN(courseId) && courseId.trim() !== '') {
                            const courseIdNum = Number(courseId);
                            if (!userGroups[courseIdNum]) {
                                userGroups[courseIdNum] = [];
                            }
                            // Only add if not already in the array (avoid duplicates)
                            if (!userGroups[courseIdNum].some(g => g.id === group.id)) {
                                userGroups[courseIdNum].push(group);
                            }
                        }
                    });
                    console.log('ğŸ‘¥ [GROUPS] Grouped by keys:', Object.keys(userGroups));
                    console.log('ğŸ‘¥ [GROUPS] Groups per key:', Object.keys(userGroups).map(key => ({
                        key: key,
                        count: userGroups[key].length,
                        groups: userGroups[key].map(g => ({ name: g.group_name, course_id: g.course_id, course_name: g.course_name }))
                    })));
                } else if (response.status === 401) {
                    // Token expired or invalid - don't redirect automatically, just skip
                    console.log('Not authenticated - skipping groups');
                    return;
                }
            } catch (error) {
                console.error('Error loading groups:', error);
            }
        }
        
        // Extract semester season from string (e.g., "×—×•×¨×£ ×ª×©×¤"×•" -> "×—×•×¨×£")
        function extractSemesterSeason(semesterString) {
            if (!semesterString || typeof semesterString !== 'string') {
                return null;
            }
            
            const trimmed = semesterString.trim();
            
            // Check if it starts with one of the season names
            if (trimmed.startsWith('×—×•×¨×£')) {
                return '×—×•×¨×£';
            } else if (trimmed.startsWith('××‘×™×‘')) {
                return '××‘×™×‘';
            } else if (trimmed.startsWith('×§×™×¥')) {
                return '×§×™×¥';
            }
            
            // If it's just the season name, return as is
            if (trimmed === '×—×•×¨×£' || trimmed === '××‘×™×‘' || trimmed === '×§×™×¥') {
                return trimmed;
            }
            
            return null;
        }
        
        // Load courses from user's courses table - only for current semester
        async function loadCourses() {
            const token = localStorage.getItem('auth_token');
            if (!token) {
                console.log('ğŸ“š [COURSES] No token, using empty courses');
                courses = []; // No hardcoded fallback - user must be logged in
                return;
            }
            
            try {
                // Load user's data (profile + courses) from /api/user-data
                const userResponse = await fetch('/api/user-data', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (userResponse.ok) {
                    const userData = await userResponse.json();
                    const userCourses = userData.courses || [];
                    const currentSemester = userData.student_info?.current_semester;
                    
                    console.log('ğŸ“š [COURSES] Loaded', userCourses.length, 'courses from user_data');
                    console.log('ğŸ“š [COURSES] Current semester from profile:', currentSemester);
                    
                    // Update the current semester and year selectors
                    const semesterSelect = document.getElementById('currentSemesterSelect');
                    const yearSelect = document.getElementById('currentYearSelect');
                    if (semesterSelect) {
                        semesterSelect.value = currentSemester || '';
                    }
                    if (yearSelect) {
                        const currentYear = userData.student_info?.current_year;
                        yearSelect.value = currentYear || '';
                    }
                    
                    if (userCourses.length > 0) {
                        console.log('ğŸ“š [COURSES] All user courses:', userCourses);
                        console.log('ğŸ“š [COURSES] Courses by semester:', userCourses.map(c => ({ name: c.course_name, semester: c.semester, year: c.year })));
                        
                        // Only show courses if current_semester is defined
                        if (currentSemester) {
                            const currentYear = userData.student_info?.current_year;
                            
                            // Extract season from current_semester (e.g., "×—×•×¨×£" from "×—×•×¨×£ ×ª×©×¤"×•")
                            const currentSemesterSeason = extractSemesterSeason(currentSemester);
                            console.log('ğŸ“š [COURSES] Filtering by semester:', currentSemester, '-> season:', currentSemesterSeason, 'and year:', currentYear);
                            
                            // Filter courses by current semester season AND year (if year is specified)
                            const filteredCourses = userCourses.filter(course => {
                                if (!course.semester) {
                                    console.log(`ğŸ“š [COURSES] Course "${course.course_name}": no semester field`);
                                    return false;
                                }
                                
                                // Extract season from course semester (e.g., "×—×•×¨×£" from "×—×•×¨×£ ×ª×©×¤"×•")
                                const courseSemesterSeason = extractSemesterSeason(course.semester);
                                
                                // Match by season (not exact string match)
                                const semesterMatches = courseSemesterSeason === currentSemesterSeason;
                                
                                // Match by year (if specified)
                                const yearMatches = !currentYear || !course.year || course.year === currentYear;
                                
                                const matches = semesterMatches && yearMatches;
                                console.log(`ğŸ“š [COURSES] Course "${course.course_name}": semester="${course.semester}" -> season="${courseSemesterSeason}" (${semesterMatches}), year="${course.year}" (${yearMatches}), currentSemester="${currentSemester}" -> season="${currentSemesterSeason}", currentYear="${currentYear}", matches=${matches}`);
                                return matches;
                            });
                            console.log('ğŸ“š [COURSES] Filtered to', filteredCourses.length, 'courses for semester season:', currentSemesterSeason, 'year:', currentYear);
                            
                            // Convert to display format
                            courses = filteredCourses.map((course, index) => {
                                const courseObj = {
                                    id: course.id || String(index + 1),
                                    course_name: course.course_name,
                                    course_number: course.course_number,
                                    credit_points: course.credit_points,
                                    semester: course.semester || null
                                };
                                console.log(`ğŸ“š [COURSES] Mapped course ${index}:`, courseObj);
                                return courseObj;
                            });
                            console.log('ğŸ“š [COURSES] Final courses to display:', courses.length, courses);
                        } else {
                            console.log('ğŸ“š [COURSES] No current_semester in profile - showing nothing');
                            courses = []; // Empty - don't show anything if no current semester
                        }
                    } else {
                        console.log('ğŸ“š [COURSES] No user courses found');
                        courses = []; // Empty - no hardcoded fallback
                    }
                } else {
                    console.log('ğŸ“š [COURSES] Error loading user courses:', userResponse.status);
                    courses = []; // Empty - no hardcoded fallback
                }
            } catch (error) {
                console.error('ğŸ“š [COURSES] Error loading courses:', error);
                courses = []; // Empty - no hardcoded fallback
            }
        }
        
        // Load assignments from Supabase
        async function loadAllAssignments() {
            try {
                console.log('ğŸ” [ASSIGNMENTS] Fetching assignments from /api/assignments');
                const response = await fetch('/api/assignments');
                
                console.log('ğŸ” [ASSIGNMENTS] Response status:', response.status, response.statusText);
                
                if (response.ok) {
                    const data = await response.json();
                    assignmentsData = data.assignments || {};
                    
                    console.log('ğŸ” [ASSIGNMENTS] Raw data from API:', data);
                    console.log('ğŸ” [ASSIGNMENTS] Assignment keys:', Object.keys(assignmentsData));
                    
                    // Debug: log all assignments with their course info
                    for (const key in assignmentsData) {
                        const assignments = assignmentsData[key];
                        if (Array.isArray(assignments) && assignments.length > 0) {
                            const first = assignments[0];
                            const courseInfo = first.course_info || first.course_catalog || {};
                            const directCourseNumber = first.course_number; // Direct field
                            const catalogCourseNumber = courseInfo.course_number; // From course_catalog
                            console.log(`ğŸ” [ASSIGNMENTS] Key "${key}": ${assignments.length} assignments`);
                            console.log(`   - course_number (direct): "${directCourseNumber}"`);
                            console.log(`   - course_number (from catalog): "${catalogCourseNumber}"`);
                            console.log(`   - course_name: "${courseInfo.course_name}"`);
                        }
                    }
                    
                    // Calculate days remaining for each assignment and create lookups
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    
                    // Also create a reverse lookup by course name and course_number for easier matching
                    const assignmentsByCourseName = {};
                    const assignmentsByCourseNumber = {};
                    
                    for (const key in assignmentsData) {
                        const assignments = assignmentsData[key];
                        if (Array.isArray(assignments)) {
                            assignments.forEach(assignment => {
                                if (assignment.due_date) {
                                    const dueDate = new Date(assignment.due_date);
                                    dueDate.setHours(0, 0, 0, 0);
                                    const diffTime = dueDate - today;
                                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                                    assignment.days_remaining = diffDays;
                } else {
                                    assignment.days_remaining = 0;
                                }
                            });
                            
                            // Create lookups by course name and course_number
                            if (assignments.length > 0) {
                                const firstAssignment = assignments[0];
                                // Prefer course_number directly from assignment, then from course_info/course_catalog
                                const directCourseNumber = firstAssignment.course_number;
                                const courseInfo = firstAssignment.course_info || firstAssignment.course_catalog || {};
                                const courseName = courseInfo.course_name;
                                const courseNumber = directCourseNumber || courseInfo.course_number;
                                
                                console.log('ğŸ” [ASSIGNMENTS] Processing key:', key, 'courseNumber:', courseNumber, 'direct:', directCourseNumber);
                                
                                if (courseName) {
                                    assignmentsByCourseName[courseName] = assignments;
                                }
                                if (courseNumber) {
                                    const courseNumberStr = String(courseNumber).trim();
                                    assignmentsByCourseNumber[courseNumber] = assignments;
                                    assignmentsByCourseNumber[courseNumberStr] = assignments;
                                }
                            }
                        }
                    }
                    
                    // Merge all lookups (by original key, course_number, and course_name)
                    assignmentsData = { 
                        ...assignmentsData, 
                        ...assignmentsByCourseName, 
                        ...assignmentsByCourseNumber 
                    };
                    
                    console.log('ğŸ” [ASSIGNMENTS] Final assignment keys:', Object.keys(assignmentsData));
                    
                    // Debug: log all assignments with their course info
                    for (const key in assignmentsData) {
                        const assignments = assignmentsData[key];
                        if (Array.isArray(assignments) && assignments.length > 0) {
                            const first = assignments[0];
                            console.log(`ğŸ” [ASSIGNMENTS DEBUG] Key "${key}":`, {
                                count: assignments.length,
                                firstAssignmentTitle: first.title,
                                courseInfo: first.course_info || first.course_catalog || 'NO COURSE INFO',
                                courseNumber: (first.course_info || first.course_catalog || {}).course_number,
                                courseName: (first.course_info || first.course_catalog || {}).course_name
                            });
                        }
                    }
                } else {
                    console.error('ğŸ” [ASSIGNMENTS] Error loading assignments:', response.status);
                    const errorText = await response.text();
                    console.error('ğŸ” [ASSIGNMENTS] Error response:', errorText);
                    assignmentsData = {};
                }
            } catch (error) {
                console.error('ğŸ” [ASSIGNMENTS] Error loading assignments:', error);
                assignmentsData = {};
            }
            
            // Fallback: If no assignments loaded from Supabase, try sample endpoint
            if (!assignmentsData || Object.keys(assignmentsData).length === 0) {
                console.log('ğŸ” [ASSIGNMENTS] No assignments from Supabase, trying sample endpoint');
                try {
                    const sampleResponse = await fetch('/api/assignments/sample');
                    if (sampleResponse.ok) {
                        const sampleData = await sampleResponse.json();
                        assignmentsData = sampleData.assignments || {};
                        console.log('ğŸ” [ASSIGNMENTS] Loaded sample assignments:', Object.keys(assignmentsData).length, 'courses');
                    }
                } catch (sampleError) {
                    console.log('ğŸ” [ASSIGNMENTS] Could not load sample assignments:', sampleError);
                    assignmentsData = {};
                }
            }
        }
        
        // OLD CODE - Hardcoded assignments (kept for reference, not used)
        function loadAllAssignments_OLD() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Calculate days remaining for each assignment
            assignmentsData = {
                '1': [
                    {
                        id: 'a1',
                        course_id: '1',
                        title: '×ª×¨×’×™×œ 1: ××©×ª× ×™× ×•×§×œ×˜',
                        description: '×›×ª×•×‘ ×ª×•×›× ×™×ª ×‘×¤×™×™×ª×•×Ÿ ×œ×§×œ×˜ ×•×¢×™×‘×•×“ ××©×ª× ×™×. ×”×’×©×” ×“×¨×š Moodle.',
                        due_date: new Date(today.getTime() + 3 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        is_completed: false
                    },
                    {
                        id: 'a2',
                        course_id: '1',
                        title: '×ª×¨×’×™×œ 2: ×œ×•×œ××•×ª ×•×‘×™×˜×•×™×™×',
                        description: '×¤×ª×¨×•×Ÿ ×ª×¨×’×™×œ×™× ×¢×œ ×œ×•×œ××•×ª for ×•-while, ×ª× ××™× if/else',
                        due_date: new Date(today.getTime() + 10 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        is_completed: false
                    },
                    {
                        id: 'a3',
                        course_id: '1',
                        title: '×ª×¨×’×™×œ 3: ×¤×•× ×§×¦×™×•×ª ×•×¨×©×™××•×ª',
                        description: '××™××•×© ×¤×•× ×§×¦×™×•×ª ×•×¢×‘×•×“×” ×¢× ×¨×©×™××•×ª ×‘×¤×™×™×ª×•×Ÿ',
                        due_date: new Date(today.getTime() + 17 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        is_completed: false
                    },
                    {
                        id: 'a4',
                        course_id: '1',
                        title: '××‘×—×Ÿ ××—×¦×”',
                        description: '××‘×—×Ÿ ×¢×œ ×›×œ ×”×—×•××¨ ×¢×“ ×›×” - ××©×ª× ×™×, ×œ×•×œ××•×ª, ×¤×•× ×§×¦×™×•×ª',
                        due_date: new Date(today.getTime() + 25 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        is_completed: false
                    }
                ],
                '2': [
                    {
                        id: 'a5',
                        course_id: '2',
                        title: '××™××•×© LinkedList',
                        description: '××™××•×© ××‘× ×” LinkedList ×¢× ×¤×¢×•×œ×•×ª ×‘×¡×™×¡×™×•×ª: ×”×•×¡×¤×”, ××—×™×§×”, ×—×™×¤×•×©',
                        due_date: new Date(today.getTime() + 5 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        is_completed: false
                    },
                    {
                        id: 'a6',
                        course_id: '2',
                        title: '×ª×¨×’×™×œ Stack ×•-Queue',
                        description: '××™××•×© ×•×§×¨×™××” ×ª×•×“×¢×” ×©×œ Stack ×•-Queue ×¢× ×“×•×’×××•×ª ×©×™××•×©',
                        due_date: new Date(today.getTime() + 12 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        is_completed: false
                    },
                    {
                        id: 'a7',
                        course_id: '2',
                        title: '××™××•×© Binary Tree',
                        description: '××™××•×© ×¢×¥ ×‘×™× ××¨×™ ×¢× ×¤×¢×•×œ×•×ª: ×”×•×¡×¤×”, ×—×™×¤×•×©, ××¢×‘×¨ (traversal)',
                        due_date: new Date(today.getTime() + 19 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        is_completed: false
                    }
                ],
                '3': [
                    {
                        id: 'a8',
                        course_id: '3',
                        title: '× ×™×ª×•×— ××•×¨×›×‘×•×ª ××œ×’×•×¨×™×ª××™×',
                        description: '×—×™×©×•×‘ Big O complexity ×œ××œ×’×•×¨×™×ª××™× ×©×•× ×™× - ××™×•×Ÿ, ×—×™×¤×•×©, ×¨×§×•×¨×¡×™×”',
                        due_date: new Date(today.getTime() + 4 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        is_completed: false
                    },
                    {
                        id: 'a9',
                        course_id: '3',
                        title: '××™××•×© ××œ×’×•×¨×™×ª××™ ××™×•×Ÿ',
                        description: '××™××•×© QuickSort, MergeSort, HeapSort ×•×”×©×•×•××” ×‘×™× ×™×”×',
                        due_date: new Date(today.getTime() + 11 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        is_completed: false
                    },
                    {
                        id: 'a10',
                        course_id: '3',
                        title: '××œ×’×•×¨×™×ª××™ ×’×¨×¤×™×',
                        description: '××™××•×© BFS ×•-DFS, Dijkstra, ×•×¤×ª×¨×•×Ÿ ×‘×¢×™×•×ª ×’×¨×¤×™×',
                        due_date: new Date(today.getTime() + 18 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        is_completed: false
                    }
                ],
                '4': [
                    {
                        id: 'a11',
                        course_id: '4',
                        title: '×©××™×œ×ª×•×ª SQL ×‘×¡×™×¡×™×•×ª',
                        description: '×›×ª×•×‘ ×©××™×œ×ª×•×ª SELECT, INSERT, UPDATE, DELETE ×¢×œ ×‘×¡×™×¡ × ×ª×•× ×™× ×œ×“×•×’××”',
                        due_date: new Date(today.getTime() + 2 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        is_completed: false
                    },
                    {
                        id: 'a12',
                        course_id: '4',
                        title: '×¢×™×¦×•×‘ ER Diagram',
                        description: '×¢×™×¦×•×‘ ××•×“×œ ER ×œ×‘×¡×™×¡ × ×ª×•× ×™× - ×–×™×”×•×™ ×™×©×•×™×•×ª, ×§×©×¨×™×, ××¤×ª×—×•×ª',
                        due_date: new Date(today.getTime() + 9 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        is_completed: true
                    },
                    {
                        id: 'a13',
                        course_id: '4',
                        title: '× ×¨××•×œ ×‘×¡×™×¡ × ×ª×•× ×™×',
                        description: '× ×¨××•×œ ×‘×¡×™×¡ × ×ª×•× ×™× ×œ-3NF - ×–×™×”×•×™ ×ª×œ×•×™×•×ª, ××¤×ª×—×•×ª ×¨××©×™×™×',
                        due_date: new Date(today.getTime() + 16 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        is_completed: false
                    }
                ],
                '5': [
                    {
                        id: 'a14',
                        course_id: '5',
                        title: '××‘× ×” OOP ×‘×¡×™×¡×™',
                        description: '×™×¦×™×¨×ª Classes, Inheritance ×•-Polymorphism ×‘×©×¤×ª Java',
                        due_date: new Date(today.getTime() + 6 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        is_completed: false
                    },
                    {
                        id: 'a15',
                        course_id: '5',
                        title: '××™××•×© Design Patterns',
                        description: '××™××•×© Singleton, Factory, Observer patterns',
                        due_date: new Date(today.getTime() + 13 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        is_completed: false
                    },
                    {
                        id: 'a16',
                        course_id: '5',
                        title: '×¤×¨×•×™×§×˜ ×¡×•×¤×™ - ××¢×¨×›×ª × ×™×”×•×œ',
                        description: '×¤×™×ª×•×— ××¢×¨×›×ª × ×™×”×•×œ ××œ××” ×¢× OOP - Classes, Interfaces, Abstract Classes',
                        due_date: new Date(today.getTime() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        is_completed: false
                    }
                ],
                '6': [
                    {
                        id: 'a17',
                        course_id: '6',
                        title: '×¤×¨×•×˜×•×§×•×œ×™ TCP/IP',
                        description: '××˜×œ×” ×¢×œ ×¤×¨×•×˜×•×§×•×œ×™ ×ª×§×©×•×¨×ª - TCP, UDP, HTTP, HTTPS',
                        due_date: new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        is_completed: false
                    },
                    {
                        id: 'a18',
                        course_id: '6',
                        title: '××™××•×© Client-Server',
                        description: '×›×ª×™×‘×ª ×ª×•×›× ×™×ª Client-Server ×¢× Sockets - TCP ×•-UDP',
                        due_date: new Date(today.getTime() + 14 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        is_completed: false
                    },
                    {
                        id: 'a19',
                        course_id: '6',
                        title: '××‘×˜×—×ª ×¨×©×ª×•×ª',
                        description: '× ×™×ª×•×— ××‘×˜×—×” ×‘×¨×©×ª×•×ª - Firewall, VPN, Encryption',
                        due_date: new Date(today.getTime() + 21 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        is_completed: false
                    }
                ]
            };
            
            // Calculate days remaining for each assignment
            for (const courseId in assignmentsData) {
                assignmentsData[courseId].forEach(assignment => {
                    if (assignment.due_date) {
                        const dueDate = new Date(assignment.due_date);
                        dueDate.setHours(0, 0, 0, 0);
                        const diffTime = dueDate - today;
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        assignment.days_remaining = diffDays;
                    } else {
                        assignment.days_remaining = 0;
                    }
                });
            }
        }
        
        // Get assignments for a specific course
        function getCourseAssignments(courseId) {
            // Try multiple ways to match
            let assignments = [];
            
            // Build list of all possible keys to try
            const possibleKeys = new Set();
            
            // Add the courseId in various formats
            possibleKeys.add(courseId);
            possibleKeys.add(String(courseId));
            if (!isNaN(courseId)) {
                possibleKeys.add(Number(courseId));
            }
            
            // Find the course object to get more keys
            const course = courses.find(c => {
                return c.id === courseId || 
                       c.course_number === courseId || 
                       String(c.id) === String(courseId) ||
                       String(c.course_number) === String(courseId);
            });
            
            if (course) {
                // Add course.id in various formats
                if (course.id !== undefined) {
                    possibleKeys.add(course.id);
                    possibleKeys.add(String(course.id));
                    if (!isNaN(course.id)) {
                        possibleKeys.add(Number(course.id));
                    }
                }
                // Add course.course_number in various formats
                if (course.course_number) {
                    possibleKeys.add(course.course_number);
                    possibleKeys.add(String(course.course_number));
                    if (!isNaN(course.course_number)) {
                        possibleKeys.add(Number(course.course_number));
                    }
                }
            }
            
            // Try each key
            for (const key of possibleKeys) {
                if (assignmentsData && assignmentsData[key] && Array.isArray(assignmentsData[key]) && assignmentsData[key].length > 0) {
                    assignments = assignmentsData[key];
                    break;
                }
            }
            
            return assignments;
        }
        
        // View group details
        function viewGroup(groupId) {
            // Open group chat page
            window.location.href = `/group/${groupId}`;
        }
        
        // Initialize year selector with current year and nearby years
        function initializeYearSelector() {
            const yearSelect = document.getElementById('currentYearSelect');
            if (!yearSelect) return;
            
            const currentYear = new Date().getFullYear();
            yearSelect.innerHTML = '<option value="">-- ×‘×—×¨ ×©× ×” --</option>';
            
            // Add years: current year and Â±2 years
            for (let year = currentYear - 2; year <= currentYear + 2; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            }
        }
        
        // Save current semester and year to user profile
        async function saveCurrentSemesterAndYear() {
            const token = localStorage.getItem('auth_token');
            if (!token) {
                alert('×× × ×”×ª×—×‘×¨ ×›×“×™ ×œ×©××•×¨ ××ª ×”×¡××¡×˜×¨ ×”× ×•×›×—×™');
                window.location.href = '/login';
                return;
            }
            
            // Check if token looks valid
            if (!token.includes('.') || token.length < 50) {
                console.error('ğŸ’¾ [SAVE SEMESTER] Invalid token format');
                alert('×˜×•×§×Ÿ ×œ× ×ª×§×™×Ÿ. ×× × ×”×ª×—×‘×¨ ××—×“×©.');
                localStorage.removeItem('auth_token');
                localStorage.removeItem('user_id');
                localStorage.removeItem('user_email');
                window.location.href = '/login';
                return;
            }
            
            const semester = document.getElementById('currentSemesterSelect')?.value;
            const year = document.getElementById('currentYearSelect')?.value;
            
            if (!semester) {
                alert('×× × ×‘×—×¨ ×¡××¡×˜×¨');
                return;
            }
            
            if (!year) {
                alert('×× × ×‘×—×¨ ×©× ×”');
                return;
            }
            
            try {
                console.log('ğŸ’¾ [SAVE SEMESTER] Saving current semester:', semester, 'and year:', year);
                console.log('ğŸ’¾ [SAVE SEMESTER] Token length:', token.length, 'Token preview:', token.substring(0, 30) + '...');
                
                // Load current user data
                console.log('ğŸ’¾ [SAVE SEMESTER] Fetching /api/user-data');
                const userResponse = await fetch('/api/user-data', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                console.log('ğŸ’¾ [SAVE SEMESTER] Response status:', userResponse.status);
                
                if (!userResponse.ok) {
                    const errorText = await userResponse.text();
                    console.error('ğŸ’¾ [SAVE SEMESTER] Error response:', errorText);
                    
                    // If 401, token is invalid - redirect to login
                    if (userResponse.status === 401) {
                        alert('×”×˜×•×§×Ÿ ×¤×’ ×ª×•×§×£. ×× × ×”×ª×—×‘×¨ ××—×“×©.');
                        localStorage.removeItem('auth_token');
                        localStorage.removeItem('user_id');
                        localStorage.removeItem('user_email');
                        window.location.href = '/login';
                        return;
                    }
                    
                    let errorMessage = 'Failed to load user data';
                    try {
                        const errorJson = JSON.parse(errorText);
                        errorMessage = errorJson.detail || errorMessage;
                    } catch (e) {
                        errorMessage = errorText || errorMessage;
                    }
                    throw new Error(errorMessage);
                }
                
                const userData = await userResponse.json();
                const studentInfo = userData.student_info || {};
                
                // Update current_semester and current_year
                const updatedData = {
                    name: studentInfo.name || '',
                    id_number: studentInfo.id_number || '',
                    faculty: studentInfo.faculty,
                    study_track: studentInfo.study_track,
                    cumulative_average: studentInfo.cumulative_average,
                    success_rate: studentInfo.success_rate,
                    current_semester: semester,
                    current_year: parseInt(year),
                    courses: userData.courses || []
                };
                
                // Save to Supabase
                console.log('ğŸ’¾ [SAVE SEMESTER] Saving to /api/save-user:', updatedData);
                const saveResponse = await fetch('/api/save-user', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(updatedData)
                });
                
                console.log('ğŸ’¾ [SAVE SEMESTER] Save response status:', saveResponse.status);
                
                if (saveResponse.ok) {
                    console.log('âœ… Current semester and year saved successfully');
                    alert('âœ… ×”×¡××¡×˜×¨ ×•×”×©× ×” × ×©××¨×• ×‘×”×¦×œ×—×”');
                    // Reload courses to show filtered results
                    await loadCourses();
                    await displayMyCourses();
                } else {
                    const errorText = await saveResponse.text();
                    console.error('âŒ Error saving current semester:', errorText);
                    let errorMessage = '×©×’×™××” ×œ× ×™×“×•×¢×”';
                    try {
                        const error = JSON.parse(errorText);
                        errorMessage = error.detail || errorMessage;
                    } catch (e) {
                        errorMessage = errorText || errorMessage;
                    }
                    alert('×©×’×™××” ×‘×©××™×¨×ª ×”×¡××¡×˜×¨: ' + errorMessage);
                }
            } catch (error) {
                console.error('âŒ Error updating current semester:', error);
                alert('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×”×¡××¡×˜×¨: ' + error.message);
            }
        }
        
        function updateCourseSemester(courseIndex, semester) {
            if (!courses || !courses[courseIndex]) {
                console.error('Invalid course index:', courseIndex);
                return;
            }
            
            courses[courseIndex].semester = semester || null;
            
            // Auto-save to database if user is authenticated
            const token = localStorage.getItem('auth_token');
            if (token) {
                console.log('ğŸ’¾ Auto-saving semester update to database...');
                // TODO: Save to Supabase when schedule planning is implemented
                // saveScheduleToDatabase();
            } else {
                console.log('âš ï¸ User not authenticated - skipping auto-save');
            }
        }
        
        // Update assignment status
        async function updateAssignmentStatus(assignmentId, isCompleted) {
            // Update local data immediately for UI responsiveness
            for (const courseId in assignmentsData) {
                const assignments = assignmentsData[courseId];
                const assignment = assignments.find(a => a.id === assignmentId);
                if (assignment) {
                    assignment.is_completed = isCompleted;
                    console.log(`âœ… Assignment "${assignment.title}" marked as ${isCompleted ? 'completed' : 'incomplete'}`);
                    break;
                }
            }
            
            // Save to database
            try {
                const token = localStorage.getItem('auth_token');
                const response = await fetch(`/api/assignments/${assignmentId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token ? `Bearer ${token}` : ''
                    },
                    body: JSON.stringify({
                        is_completed: isCompleted
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    console.error('âŒ Error updating assignment status:', error);
                    // Revert local change on error
                    for (const courseId in assignmentsData) {
                        const assignments = assignmentsData[courseId];
                        const assignment = assignments.find(a => a.id === assignmentId);
                        if (assignment) {
                            assignment.is_completed = !isCompleted;
                            break;
                        }
                    }
                    alert('âŒ ×©×’×™××” ×‘×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡ ×”××˜×œ×”');
                    await displayMyCourses(); // Refresh to show correct state
                    return;
                }
                
                const result = await response.json();
                console.log('âœ… Assignment status saved to database:', result);
            } catch (error) {
                console.error('âŒ Error saving assignment status:', error);
                // Revert local change on error
                for (const courseId in assignmentsData) {
                    const assignments = assignmentsData[courseId];
                    const assignment = assignments.find(a => a.id === assignmentId);
                    if (assignment) {
                        assignment.is_completed = !isCompleted;
                        break;
                    }
                }
                alert('âŒ ×©×’×™××” ×‘×©××™×¨×ª ×¡×˜×˜×•×¡ ×”××˜×œ×”');
                await displayMyCourses(); // Refresh to show correct state
                return;
            }
            
            // Refresh the display
            await displayMyCourses();
        }
        
        // Add Assignment Modal Functions
        function openAddAssignmentModal(courseNumber, courseName) {
            const modal = document.getElementById('addAssignmentModal');
            document.getElementById('assignmentCourseNumber').value = courseNumber;
            document.getElementById('assignmentCourseName').value = courseName;
            document.getElementById('assignmentCourseDisplay').value = courseName;
            
            // Set default due date to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('assignmentDueDate').value = tomorrow.toISOString().split('T')[0];
            
            // Clear form
            document.getElementById('assignmentTitle').value = '';
            document.getElementById('assignmentDescription').value = '';
            document.getElementById('assignmentPriority').value = 'medium';
            
            modal.classList.add('active');
        }
        
        function closeAddAssignmentModal() {
            const modal = document.getElementById('addAssignmentModal');
            modal.classList.remove('active');
        }
        
        async function createAssignment(event) {
            event.preventDefault();
            
            const courseNumber = document.getElementById('assignmentCourseNumber').value;
            const title = document.getElementById('assignmentTitle').value;
            const description = document.getElementById('assignmentDescription').value;
            const dueDate = document.getElementById('assignmentDueDate').value;
            const priority = document.getElementById('assignmentPriority').value;
            
            if (!title || !dueDate) {
                alert('âŒ ×™×© ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª ×”×—×•×‘×”');
                return;
            }
            
            try {
                console.log('ğŸ“¤ Creating assignment:', { courseNumber, title, dueDate, priority });
                
                const response = await fetch('/api/assignments', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        course_number: courseNumber,
                        title: title,
                        description: description || null,
                        due_date: dueDate,
                        priority: priority
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    console.error('âŒ Error response:', error);
                    alert('âŒ ' + (error.detail || '×©×’×™××” ×‘×™×¦×™×¨×ª ×”××˜×œ×”'));
                    return;
                }
                
                const result = await response.json();
                console.log('âœ… Assignment created:', result);
                
                alert('âœ… ×”××˜×œ×” × ×•×¦×¨×” ×‘×”×¦×œ×—×”!');
                closeAddAssignmentModal();
                
                // Reload assignments and refresh display
                await loadAllAssignments();
            displayMyCourses();
                
            } catch (error) {
                console.error('âŒ Error creating assignment:', error);
                alert('×©×’×™××” ×‘×™×¦×™×¨×ª ×”××˜×œ×”: ' + error.message);
            }
        }
        
        // Create Group Modal Functions
        function openCreateGroupModal(courseId, courseName) {
            const modal = document.getElementById('createGroupModal');
            document.getElementById('groupCourseId').value = courseId;
            document.getElementById('groupCourseName').value = courseName;
            document.getElementById('groupName').value = `×§×‘×•×¦×ª ×œ×™××•×“ - ${courseName}`;
            modal.classList.add('active');
        }
        
        function closeCreateGroupModal() {
            const modal = document.getElementById('createGroupModal');
            modal.classList.remove('active');
            document.getElementById('createGroupForm').reset();
            // Reset email inputs
            const emailContainer = document.getElementById('inviteEmails');
            emailContainer.innerHTML = `
                <div class="email-input-row">
                    <input type="email" class="email-input" placeholder="email@example.com" />
                    <button type="button" class="btn-remove-email" onclick="removeEmailInput(this)" style="display: none;">Ã—</button>
                </div>
            `;
        }
        
        function addEmailInput() {
            const container = document.getElementById('inviteEmails');
            const newRow = document.createElement('div');
            newRow.className = 'email-input-row';
            newRow.innerHTML = `
                <input type="email" class="email-input" placeholder="email@example.com" />
                <button type="button" class="btn-remove-email" onclick="removeEmailInput(this)">Ã—</button>
            `;
            container.appendChild(newRow);
        }
        
        function removeEmailInput(btn) {
            btn.parentElement.remove();
            // Show/hide remove buttons
            const rows = document.querySelectorAll('.email-input-row');
            rows.forEach((row, index) => {
                const removeBtn = row.querySelector('.btn-remove-email');
                if (rows.length > 1) {
                    removeBtn.style.display = 'block';
                } else {
                    removeBtn.style.display = 'none';
                }
            });
        }
        
        async function createGroup(event) {
            event.preventDefault();
            
            const token = localStorage.getItem('auth_token');
            console.log('ğŸ” Token from localStorage:', token ? `Found (length: ${token.length})` : 'NOT FOUND');
            
            if (!token) {
                alert('×× × ×”×ª×—×‘×¨ ×›×“×™ ×œ×™×¦×•×¨ ×§×‘×•×¦×”');
                window.location.href = '/login';
                return;
            }
            
            // Check if token looks like a JWT
            if (!token.includes('.')) {
                console.error('âŒ Token does not look like a JWT token');
                alert('×©×’×™××”: ×˜×•×§×Ÿ ×œ× ×ª×§×™×Ÿ. ×× × ×”×ª×—×‘×¨ ××—×“×©.');
                window.location.href = '/login';
                return;
            }
            
            const courseId = document.getElementById('groupCourseId').value;
            const courseName = document.getElementById('groupCourseName').value;
            const groupName = document.getElementById('groupName').value;
            const description = document.getElementById('groupDescription').value;
            
            // Get all email inputs
            const emailInputs = document.querySelectorAll('.email-input');
            const emails = Array.from(emailInputs)
                .map(input => input.value.trim())
                .filter(email => email.length > 0);
            
            // Get current user's email from localStorage
            const currentUserEmail = localStorage.getItem('user_email');
            
            // Filter out current user's email (can't invite yourself)
            const filteredEmails = emails.filter(email => {
                const emailLower = email.toLowerCase().trim();
                const userEmailLower = currentUserEmail ? currentUserEmail.toLowerCase().trim() : '';
                if (emailLower === userEmailLower) {
                    console.warn(`âš ï¸ Skipping ${email} - cannot invite yourself`);
                    return false;
                }
                return true;
            });
            
            if (filteredEmails.length !== emails.length) {
                alert('âš ï¸ ×©×™× ×œ×‘: ×œ× × ×™×ª×Ÿ ×œ×”×–××™×Ÿ ××ª ×¢×¦××š ×œ×§×‘×•×¦×”. ×”××™×™×œ ×©×œ×š ×”×•×¡×¨ ××”×¨×©×™××”.');
            }
            
            if (filteredEmails.length === 0) {
                alert('âŒ ×¢×œ×™×š ×œ×”×–××™×Ÿ ×œ×¤×—×•×ª ××©×ª××© ×¨×©×•× ××—×“ (×œ× ××ª ×¢×¦××š)');
                return;
            }
            
            console.log('ğŸ“¤ Sending request to /api/groups/create with:', {
                course_id: courseId,
                course_name: courseName,
                group_name: groupName,
                emails_count: filteredEmails.length,
                original_emails_count: emails.length
            });
            
            try {
                const response = await fetch('/api/groups/create', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        course_id: courseId,
                        course_name: courseName,
                        group_name: groupName,
                        description: description,
                        invite_emails: filteredEmails
                    })
                });
                
                console.log('ğŸ“¥ Response status:', response.status, response.statusText);
                
                if (!response.ok) {
                    const error = await response.json();
                    console.error('âŒ Error response:', error);
                    // Show user-friendly error message
                    const errorMsg = error.detail || '×©×’×™××” ×‘×™×¦×™×¨×ª ×”×§×‘×•×¦×”';
                    alert('âŒ ' + errorMsg);
                    throw new Error(errorMsg);
                }
                
                const result = await response.json();
                console.log('âœ… Success:', result);
                
                // Build success message
                let message = 'âœ… ×”×§×‘×•×¦×” × ×•×¦×¨×” ×‘×”×¦×œ×—×”!';
                if (result.invitations_created && result.invitations_created.length > 0) {
                    message += `\n${result.invitations_created.length} ×”×–×× ×•×ª × ×©×œ×—×• ×‘×”×¦×œ×—×”.`;
                }
                
                // Show info if user tried to invite themselves
                if (result.info) {
                    message += `\n\nâ„¹ï¸ ${result.info}`;
                }
                
                // Show warning if there are failed invitations
                if (result.warning) {
                    message += `\n\nâš ï¸ ${result.warning}`;
                }
                
                alert(message);
                closeCreateGroupModal();
                // TODO: Refresh groups list
                
            } catch (error) {
                console.error('âŒ Error creating group:', error);
                alert('×©×’×™××” ×‘×™×¦×™×¨×ª ×”×§×‘×•×¦×”: ' + error.message);
            }
        }
        
        // Chat toggle (placeholder)
        function toggleChat() {
            alert('×¦\'××˜ ×™×•×ª×× ×‘×”××©×š');
        }
        
        // Initialize - display courses and notifications
        async function initializePage() {
            console.log('ğŸ” [FRONTEND] initializePage() called');
            // Show/hide current semester selector based on auth status
            const token = localStorage.getItem('auth_token');
            console.log('ğŸ” [FRONTEND] Token exists:', !!token);
            const semesterSelector = document.querySelector('.current-semester-selector');
            if (semesterSelector) {
                semesterSelector.style.display = token ? 'flex' : 'none';
            }
            
            // Initialize year selector
            initializeYearSelector();
            
            // Load courses from catalog first
            console.log('ğŸ” [FRONTEND] About to call loadCourses()');
            await loadCourses();
            console.log('ğŸ” [FRONTEND] loadCourses() completed, courses.length:', courses.length);
            
            // Load assignments
            console.log('ğŸ” [FRONTEND] Checking if loadAllAssignments exists...');
            console.log('ğŸ” [FRONTEND] typeof loadAllAssignments:', typeof loadAllAssignments);
                if (typeof loadAllAssignments === 'function') {
                console.log('âœ… [FRONTEND] loadAllAssignments is a function - calling it now');
                try {
                    await loadAllAssignments();
                    console.log('âœ… [FRONTEND] loadAllAssignments() completed successfully');
                } catch (error) {
                    console.error('âŒ [FRONTEND] Error in loadAllAssignments():', error);
                }
            } else {
                console.error('âŒ [FRONTEND] loadAllAssignments is NOT a function! It is:', typeof loadAllAssignments);
            }
            
            // Load groups
            console.log('ğŸ” [FRONTEND] About to call loadUserGroups()');
            await loadUserGroups();
            
            // Display courses
            console.log('ğŸ” [FRONTEND] About to call displayMyCourses()');
            await displayMyCourses();
            loadNotifications();
        }
        
        // Wait for DOM to be ready before initializing
        console.log('ğŸ” [DEBUG] Setting up DOM ready handler');
        console.log('ğŸ” [DEBUG] Token check at script end:', localStorage.getItem('auth_token') ? 'EXISTS' : 'MISSING');
        
        // Also check token periodically to detect if it's being cleared
        let lastTokenCheck = localStorage.getItem('auth_token');
        setInterval(() => {
            const currentToken = localStorage.getItem('auth_token');
            if (lastTokenCheck && !currentToken) {
                console.error('ğŸ” [DEBUG] âš ï¸âš ï¸âš ï¸ TOKEN WAS CLEARED! âš ï¸âš ï¸âš ï¸');
                console.error('ğŸ” [DEBUG] Previous token:', lastTokenCheck ? 'EXISTED' : 'MISSING');
                console.error('ğŸ” [DEBUG] Current token:', currentToken ? 'EXISTS' : 'MISSING');
                console.trace('ğŸ” [DEBUG] Stack trace:');
            }
            lastTokenCheck = currentToken;
        }, 1000);
        
        if (document.readyState === 'loading') {
            console.log('ğŸ” [DEBUG] DOM is loading - waiting for DOMContentLoaded');
            document.addEventListener('DOMContentLoaded', function() {
                console.log('ğŸ” [DEBUG] DOMContentLoaded fired - calling initializePage');
                console.log('ğŸ” [DEBUG] Token at DOMContentLoaded:', localStorage.getItem('auth_token') ? 'EXISTS' : 'MISSING');
        initializePage();
            });
        } else {
            // DOM is already ready
            console.log('ğŸ” [DEBUG] DOM already ready - calling initializePage immediately');
            console.log('ğŸ” [DEBUG] Token at script end:', localStorage.getItem('auth_token') ? 'EXISTS' : 'MISSING');
            initializePage();
        }
        
        // Load notifications every 60 seconds
        setInterval(() => {
            if (localStorage.getItem('auth_token')) {
                loadNotifications();
            }
        }, 60000);
    </script>
</body>
</html>
